{% extends 'pricing/base.html' %}
{% load pricing_filters %}
{% load humanize %}

{% block title %}Pricing Matrix{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

<div class="space-y-6">
    <!-- Header -->
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Pricing Matrix</h1>
        <p class="text-gray-600 mt-1">Room-centric view with B&B Standard rates</p>
    </div>
    <div class="flex space-x-2">
        <!-- View Toggle -->
        <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
            <span class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md">
                By Room
            </span>
            <a href="{% url 'pricing:pricing_matrix_channel' org_code=org.code prop_code=property.code %}" 
               class="px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md">
                By Channel
            </a>
        </div>
        <!-- PDF Export Button -->
        <a href="{% url 'pricing:pricing_matrix_pdf' org_code=org.code prop_code=property.code %}" 
           class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Export PDF
        </a>
        <!-- Back to Dashboard -->
        <a href="{% url 'pricing:property_dashboard' org_code=org.code prop_code=property.code %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Dashboard
        </a>
    </div>
</div>

    <!-- Pricing Matrix Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <!-- Table Header - Seasons -->
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="sticky left-0 z-10 bg-gray-50 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-72 border-r border-gray-300">
                            Room / Channel
                        </th>
                        {% for season in seasons %}
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium border-r border-gray-200 min-w-32">
                            <div class="font-semibold text-gray-900 hover:text-blue-600 transition cursor-pointer"
                                 onclick="openSeasonModal({{ season.id }}, '{{ season.name }}', '{{ season.start_date|date:"Y-m-d" }}', '{{ season.end_date|date:"Y-m-d" }}', '{{ season.season_index }}', '{{ season.expected_occupancy }}')">
                                {{ season.name }}
                            </div>
                            <div class="text-xs text-gray-500 font-normal mt-0.5">{{ season.start_date|date:"M d" }} - {{ season.end_date|date:"M d" }}</div>
                            <div class="text-xs text-blue-600 mt-0.5">√ó{{ season.season_index }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for room_id, room_data in matrix.items %}
                    {% with room=room_data.room %}
                    
                    <!-- ========================================================= -->
                    <!-- ROOM HEADER ROW -->
                    <!-- ========================================================= -->
                    <tr class="bg-gradient-to-r from-blue-100 to-blue-200 border-t-2 border-blue-300 cursor-pointer hover:from-blue-150 hover:to-blue-250 transition"
                        onclick="toggleSection('room-{{ room.id }}')">
                        <td class="sticky left-0 z-10 bg-gradient-to-r from-blue-100 to-blue-200 px-4 py-3 border-r border-gray-300">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-blue-600 transform transition-transform duration-200" 
                                     id="chevron-room-{{ room.id }}"
                                     viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                </svg>
                                <div>
                                    <div class="font-bold text-gray-900 text-base hover:text-blue-600 transition"
                                         onclick="event.stopPropagation(); openRoomModal({{ room.id }}, '{{ room.name }}', '{{ room.base_rate }}', '{{ room.room_index }}', '{{ room.room_adjustment }}', '{{ room.pricing_method }}', {{ room.number_of_rooms }}, {{ room.sort_order }})">
                                        {{ room.name }}
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        {{ room.number_of_rooms }} rooms ‚Ä¢ Base: ${{ room.base_rate|floatformat:2|intcomma }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-3 text-center border-r border-gray-200">
                            <!-- Empty for room header -->
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- ========================================================= -->
                    <!-- CHANNEL ROWS (Collapsible under Room) -->
                    <!-- ========================================================= -->
                    {% for channel_id, channel_data in room_data.channels.items %}
                    {% with channel=channel_data.channel %}
                    
                    <!-- Channel Summary Row - Shows B&B Standard Rate -->
                    <tr class="section-room-{{ room.id }} bg-gray-50 cursor-pointer hover:bg-gray-100 transition"
                        onclick="toggleSection('room-{{ room.id }}-channel-{{ channel.id }}')">
                        <td class="sticky left-0 z-10 bg-gray-50 hover:bg-gray-100 px-4 py-2 border-r border-gray-300">
                            <div class="flex items-center space-x-2 pl-6">
                                <svg class="w-4 h-4 text-gray-500 transform transition-transform duration-200 -rotate-90" 
                                     id="chevron-room-{{ room.id }}-channel-{{ channel.id }}"
                                     viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                </svg>
                                <div>
                                    <div class="font-semibold text-gray-800">{{ channel.name }}</div>
                                    <div class="text-xs text-gray-500">
                                        {% if channel.base_discount_percent > 0 %}
                                        <span class="text-green-600">-{{ channel.base_discount_percent }}%</span>
                                        {% endif %}
                                        {% if channel.commission_percent > 0 %}
                                        <span class="text-amber-600 ml-1">{{ channel.commission_percent }}% comm</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-2 text-center border-r border-gray-200">
                            {% with rate=channel_data.summary_rates|get_item:season.id %}
                            {% if rate %}
                            <div class="font-semibold text-gray-900">${{ rate|floatformat:2|intcomma }}</div>
                            <div class="text-xs text-gray-500">B&B Std</div>
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- ========================================================= -->
                    <!-- CHANNEL BREAKDOWN (Collapsible - Rate Plans & Modifiers) -->
                    <!-- ========================================================= -->
                    {% for rate_plan_id, rp_data in channel_data.rate_plans.items %}
                    {% with rate_plan=rp_data.rate_plan %}
                    
                    <!-- Rate Plan Header -->
                    <tr class="section-room-{{ room.id }}-channel-{{ channel.id }} hidden bg-blue-50 border-t border-blue-100">
                        <td class="sticky left-0 z-10 bg-blue-50 px-4 py-2 border-r border-gray-300">
                            <div class="pl-12 font-medium text-gray-800">
                                {{ rate_plan.name }}
                                {% if rate_plan.meal_supplement > 0 %}
                                <span class="text-xs text-gray-500 font-normal">(+${{ rate_plan.meal_supplement|floatformat:2 }}/person)</span>
                                {% endif %}
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-3 py-2 text-center border-r border-gray-200">
                            <!-- Empty for rate plan header -->
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- BAR Row -->
                    <tr class="section-room-{{ room.id }}-channel-{{ channel.id }} hidden bg-white">
                        <td class="sticky left-0 z-10 bg-white px-4 py-1.5 border-r border-gray-300">
                            <div class="pl-16 text-xs text-gray-600 font-medium">BAR</div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-3 py-1.5 text-center text-sm text-gray-700 border-r border-gray-200">
                            {% with bar=rp_data.bar_rates|get_item:season.id %}
                            {% if bar %}${{ bar|floatformat:2|intcomma }}{% else %}‚Äî{% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Modifier Rows -->
                    {% for mod_data in rp_data.modifiers %}
                    <tr class="section-room-{{ room.id }}-channel-{{ channel.id }} hidden bg-white hover:bg-gray-50 transition">
                        <td class="sticky left-0 z-10 bg-white hover:bg-gray-50 px-4 py-1.5 border-r border-gray-300">
                            <div class="pl-16 flex items-center space-x-2">
                                <span class="text-sm">
                                    {% if mod_data.modifier.modifier_type == 'member' %}üéØ
                                    {% elif mod_data.modifier.modifier_type == 'mobile' %}üì±
                                    {% elif mod_data.modifier.modifier_type == 'promo' %}üìß
                                    {% elif mod_data.modifier.modifier_type == 'last_minute' %}‚ö°
                                    {% elif mod_data.modifier.modifier_type == 'early_bird' %}üê¶
                                    {% elif mod_data.modifier.modifier_type == 'corporate' %}üè¢
                                    {% else %}‚Ä¢{% endif %}
                                </span>
                                <div class="text-xs">
                                    <span class="text-gray-700">{{ mod_data.modifier.name }}</span>
                                    {% if mod_data.modifier.discount_percent > 0 %}
                                    <span class="text-green-600 ml-1">-{{ mod_data.modifier.discount_percent }}%</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-3 py-1.5 text-center relative tooltip-trigger border-r border-gray-200">
                            {% with season_rates=mod_data.seasons|get_item:season.id %}
                            {% if season_rates %}
                            <div class="text-sm font-medium text-gray-900">${{ season_rates.rate|floatformat:2|intcomma }}</div>
                            {% if channel.commission_percent > 0 %}
                            <div class="text-xs text-gray-500">Net: ${{ season_rates.breakdown.net_revenue|floatformat:2|intcomma }}</div>
                            {% endif %}
                            
                            <!-- Tooltip -->
                            <div class="tooltip absolute z-20 w-56 bg-gray-900 text-white text-xs rounded-lg shadow-lg p-3 left-1/2 transform -translate-x-1/2 top-full mt-1">
                                <div class="font-semibold mb-1">{{ mod_data.modifier.name }}</div>
                                <div class="text-xs text-gray-400 mb-2">{{ room.name }} ‚Ä¢ {{ rate_plan.name }}</div>
                                <div class="space-y-0.5">
                                    <div class="flex justify-between"><span>Base:</span><span>${{ season_rates.breakdown.base_rate|floatformat:2 }}</span></div>
                                    <div class="flex justify-between"><span>√ó Season:</span><span>${{ season_rates.breakdown.seasonal_rate|floatformat:2 }}</span></div>
                                    {% if season_rates.breakdown.meal_cost > 0 %}
                                    <div class="flex justify-between"><span>+ Meals:</span><span>${{ season_rates.breakdown.meal_cost|floatformat:2 }}</span></div>
                                    {% endif %}
                                    <div class="flex justify-between border-t border-gray-700 pt-1 font-semibold"><span>BAR:</span><span>${{ season_rates.breakdown.bar_rate|floatformat:2 }}</span></div>
                                    {% if season_rates.breakdown.total_discount_percent > 0 %}
                                    <div class="flex justify-between"><span>- Discount:</span><span>-{{ season_rates.breakdown.total_discount_percent }}%</span></div>
                                    {% endif %}
                                    <div class="flex justify-between border-t border-gray-700 pt-1 font-bold text-green-300"><span>Guest Pays:</span><span>${{ season_rates.breakdown.final_rate|floatformat:2 }}</span></div>
                                    {% if channel.commission_percent > 0 %}
                                    <div class="flex justify-between pt-1 border-t border-gray-700"><span>- Commission:</span><span class="text-red-300">-${{ season_rates.breakdown.commission_amount|floatformat:2 }}</span></div>
                                    <div class="flex justify-between font-bold text-blue-300"><span>You Receive:</span><span>${{ season_rates.breakdown.net_revenue|floatformat:2 }}</span></div>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    
                    {% endwith %}
                    {% endfor %}
                    
                    {% endwith %}
                    {% endfor %}
                    
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-2">Legend</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
            <div><span class="font-semibold">B&B Std:</span> Bed & Breakfast Standard rate</div>
            <div><span class="font-semibold">BAR:</span> Best Available Rate</div>
            <div><span class="font-semibold">Net:</span> Your revenue after commission</div>
            <div><span class="font-semibold">Hover:</span> See full breakdown</div>
        </div>
    </div>

    <!-- Room Edit Modal -->
    <div id="roomModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-900">Edit Room</h3>
                <button onclick="closeRoomModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="roomForm" class="mt-4">
                <input type="hidden" id="room_id" name="room_id">
                <div class="space-y-4">
                    <div>
                        <label for="room_name" class="block text-sm font-medium text-gray-700 mb-1">Room Name *</label>
                        <input type="text" id="room_name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="pricing_method" class="block text-sm font-medium text-gray-700 mb-1">Pricing Method *</label>
                        <select id="pricing_method" name="pricing_method" required onchange="updatePricingFields()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="direct">Direct Base Rate</option>
                            <option value="index">Index Multiplier</option>
                            <option value="adjustment">Fixed Adjustment</option>
                        </select>
                    </div>
                    <div>
                        <label for="base_rate" class="block text-sm font-medium text-gray-700 mb-1">Base Rate ($) *</label>
                        <input type="number" id="base_rate" name="base_rate" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="room_index_field">
                        <label for="room_index" class="block text-sm font-medium text-gray-700 mb-1">Room Index</label>
                        <input type="number" id="room_index" name="room_index" step="0.01" min="0" value="1.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="room_adjustment_field">
                        <label for="room_adjustment" class="block text-sm font-medium text-gray-700 mb-1">Room Adjustment ($)</label>
                        <input type="number" id="room_adjustment" name="room_adjustment" step="0.01" value="0.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="number_of_rooms" class="block text-sm font-medium text-gray-700 mb-1">Number of Rooms *</label>
                        <input type="number" id="number_of_rooms" name="number_of_rooms" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="sort_order" class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                        <input type="number" id="sort_order" name="sort_order" min="0" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-4 mt-4 border-t">
                    <button type="button" onclick="closeRoomModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Season Edit Modal -->
    <div id="seasonModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-900">Edit Season</h3>
                <button onclick="closeSeasonModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="seasonForm" class="mt-4">
                <input type="hidden" id="season_id" name="season_id">
                <div class="space-y-4">
                    <div>
                        <label for="season_name" class="block text-sm font-medium text-gray-700 mb-1">Season Name *</label>
                        <input type="text" id="season_name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                            <input type="date" id="start_date" name="start_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
                            <input type="date" id="end_date" name="end_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="season_index" class="block text-sm font-medium text-gray-700 mb-1">Season Index *</label>
                        <input type="number" id="season_index" name="season_index" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="expected_occupancy" class="block text-sm font-medium text-gray-700 mb-1">Expected Occupancy (%) *</label>
                        <input type="number" id="expected_occupancy" name="expected_occupancy" step="0.01" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-4 mt-4 border-t">
                    <button type="button" onclick="closeSeasonModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sticky { position: sticky; }
    .tooltip { display: none; pointer-events: none; }
    .tooltip-trigger:hover .tooltip { display: block; }
    
    /* Compact table spacing */
    table th, table td {
        padding: 0.5rem 0.75rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Toggle section visibility
function toggleSection(sectionId) {
    var sections = document.querySelectorAll('.section-' + sectionId);
    var chevron = document.getElementById('chevron-' + sectionId);
    var isHidden = sections.length > 0 && sections[0].classList.contains('hidden');
    
    sections.forEach(function(section) {
        if (isHidden) {
            section.classList.remove('hidden');
        } else {
            section.classList.add('hidden');
        }
    });
    
    if (chevron) {
        if (isHidden) {
            chevron.style.transform = 'rotate(0deg)';
        } else {
            chevron.style.transform = 'rotate(-90deg)';
        }
    }
}

// Room modal functions
function openRoomModal(roomId, name, baseRate, roomIndex, roomAdjustment, pricingMethod, numberOfRooms, sortOrder) {
    document.getElementById('room_id').value = roomId;
    document.getElementById('room_name').value = name;
    document.getElementById('base_rate').value = baseRate;
    document.getElementById('room_index').value = roomIndex;
    document.getElementById('room_adjustment').value = roomAdjustment;
    document.getElementById('pricing_method').value = pricingMethod;
    document.getElementById('number_of_rooms').value = numberOfRooms;
    document.getElementById('sort_order').value = sortOrder;
    updatePricingFields();
    document.getElementById('roomModal').classList.remove('hidden');
}

function closeRoomModal() {
    document.getElementById('roomModal').classList.add('hidden');
    document.getElementById('roomForm').reset();
}

// Season modal functions
function openSeasonModal(seasonId, name, startDate, endDate, seasonIndex, expectedOccupancy) {
    document.getElementById('season_id').value = seasonId;
    document.getElementById('season_name').value = name;
    document.getElementById('start_date').value = startDate;
    document.getElementById('end_date').value = endDate;
    document.getElementById('season_index').value = seasonIndex;
    document.getElementById('expected_occupancy').value = expectedOccupancy;
    document.getElementById('seasonModal').classList.remove('hidden');
}

function closeSeasonModal() {
    document.getElementById('seasonModal').classList.add('hidden');
    document.getElementById('seasonForm').reset();
}

// Update pricing fields visibility
function updatePricingFields() {
    var method = document.getElementById('pricing_method').value;
    var indexField = document.getElementById('room_index_field');
    var adjustmentField = document.getElementById('room_adjustment_field');
    
    if (method === 'direct') {
        indexField.classList.add('hidden');
        adjustmentField.classList.add('hidden');
    } else if (method === 'index') {
        indexField.classList.remove('hidden');
        adjustmentField.classList.add('hidden');
    } else if (method === 'adjustment') {
        indexField.classList.add('hidden');
        adjustmentField.classList.remove('hidden');
    }
}

// Form submissions
document.getElementById('roomForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    var roomId = formData.get('room_id');
    var url = "{% url 'pricing:update_room' org_code=org.code prop_code=prop.code room_id=0 %}".replace('/0/', '/' + roomId + '/');
    
    fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            closeRoomModal();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(function(error) {
        alert('Error saving room.');
    });
});

document.getElementById('seasonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    var seasonId = formData.get('season_id');
    var url = "{% url 'pricing:update_season' org_code=org.code prop_code=prop.code season_id=0 %}".replace('/0/', '/' + seasonId + '/');
    
    fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            closeSeasonModal();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(function(error) {
        alert('Error saving season.');
    });
});

// Get CSRF token
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modals on outside click
document.getElementById('roomModal').addEventListener('click', function(e) {
    if (e.target === this) closeRoomModal();
});
document.getElementById('seasonModal').addEventListener('click', function(e) {
    if (e.target === this) closeSeasonModal();
});
</script>
{% endblock %}