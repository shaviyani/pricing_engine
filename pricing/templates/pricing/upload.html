{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Import Reservations{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    ‚Ä∫ <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_label|capfirst }}</a>
    ‚Ä∫ <a href="{% url 'admin:pricing_fileimport_changelist' %}">File Imports</a>
    ‚Ä∫ Import Reservations
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
        
        <!-- Instructions Card -->
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h2 style="margin-top: 0; color: #333;">üì§ Import Reservation Data</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Upload an Excel or CSV file containing reservation data from your PMS.
            </p>
            
            <h4 style="margin-bottom: 10px;">Supported Formats:</h4>
            <ul style="color: #666; margin-bottom: 15px;">
                <li>Excel (.xlsx, .xls)</li>
                <li>CSV (.csv)</li>
            </ul>
            
            <h4 style="margin-bottom: 10px;">Expected Columns:</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #e9ecef;">
                        <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Column</th>
                        <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Required</th>
                        <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>Conf. No</strong></td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">‚úÖ Yes</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">286, 286-1</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>Arrival</strong></td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">‚úÖ Yes</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">2026-01-15</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>Departure</strong></td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">‚úÖ Yes</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">2026-01-20</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Booked On</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Recommended</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">2025-12-01</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Nights</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">5</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Room No</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">116 Standard</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Source</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Booking.com</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">User</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Reekko</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Rate Plan</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Half Board</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Grand Total</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">1250.00</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Guest</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">John Smith</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Country</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">Optional</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6;">United Kingdom</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Processing Notes -->
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Processing Notes:</h4>
            <ul style="margin: 0; padding-left: 20px; color: #856404;">
                <li><strong>Day-use bookings</strong> (Nights=0) will be filtered out</li>
                <li><strong>Multi-room bookings</strong> (286-1, 286-2) will be linked automatically</li>
                <li><strong>Empty Source + User</strong> (Reekko/Maais) will be mapped to Direct</li>
                <li><strong>Duplicate confirmations</strong> will update existing records</li>
            </ul>
        </div>
        
        <!-- Upload Form -->
        <div style="background: white; border: 2px dashed #007bff; border-radius: 8px; padding: 30px; text-align: center;">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div style="margin-bottom: 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#007bff" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                </div>
                
                <!-- Property Selector -->
                <div style="margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <label for="hotel" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        üè® Select Property: <span style="color: #dc3545;">*</span>
                    </label>
                    <select name="hotel" 
                            id="hotel" 
                            style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: white;"
                            required>
                        <option value="">-- Select a Property --</option>
                        {% for prop in properties %}
                        <option value="{{ prop.id }}">
                            {{ prop.name }}{% if prop.organization %} ({{ prop.organization.name }}){% endif %}
                        </option>
                        {% empty %}
                        <option value="" disabled>No properties configured</option>
                        {% endfor %}
                    </select>
                    <p style="margin-top: 5px; font-size: 12px; color: #666;">
                        Reservations will be assigned to this property.
                    </p>
                </div>
                
                <!-- File Input -->
                <div style="margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <label for="file" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                        üìÑ Select File to Import: <span style="color: #dc3545;">*</span>
                    </label>
                    <input type="file" 
                           name="file" 
                           id="file" 
                           accept=".xlsx,.xls,.csv"
                           style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
                           required>
                    <p id="file-info" style="margin-top: 5px; font-size: 12px; color: #666;"></p>
                </div>
                
                <button type="submit" 
                        id="submit-btn"
                        style="background: #007bff; color: white; border: none; padding: 12px 30px; 
                               border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold;">
                    üì• Import Reservations
                </button>
            </form>
        </div>
        
        <!-- Setup Reminder -->
        <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 8px; padding: 15px; margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #0c5460;">üí° Before Importing:</h4>
            <ol style="margin: 0; padding-left: 20px; color: #0c5460;">
                <li>Configure <a href="{% url 'admin:pricing_bookingsource_changelist' %}">Booking Sources</a> to map import values to channels</li>
                <li>Ensure <a href="{% url 'admin:pricing_roomtype_changelist' %}">Room Types</a> match your import data</li>
                <li>Ensure <a href="{% url 'admin:pricing_rateplan_changelist' %}">Rate Plans</a> match your import data</li>
            </ol>
        </div>
        
        {% if not properties %}
        <!-- No Properties Warning -->
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #721c24;">‚ö†Ô∏è No Properties Configured</h4>
            <p style="margin: 0; color: #721c24;">
                You need to create at least one property before importing reservations.
                <a href="{% url 'admin:pricing_property_add' %}">Create a Property</a>
            </p>
        </div>
        {% endif %}
        
    </div>
</div>

<script>
// File name display
document.getElementById('file').addEventListener('change', function(e) {
    var fileInfo = document.getElementById('file-info');
    if (this.files.length > 0) {
        var fileName = this.files[0].name;
        var fileSize = (this.files[0].size / 1024).toFixed(1);
        fileInfo.textContent = 'Selected: ' + fileName + ' (' + fileSize + ' KB)';
        fileInfo.style.color = '#28a745';
    } else {
        fileInfo.textContent = '';
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    var hotel = document.getElementById('hotel').value;
    var file = document.getElementById('file').value;
    
    if (!hotel) {
        e.preventDefault();
        alert('Please select a property before importing.');
        document.getElementById('hotel').focus();
        return false;
    }
    
    if (!file) {
        e.preventDefault();
        alert('Please select a file to import.');
        document.getElementById('file').focus();
        return false;
    }
    
    // Show loading state
    var btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Importing... Please wait';
    btn.style.background = '#6c757d';
});
</script>
{% endblock %}