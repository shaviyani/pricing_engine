<!-- 
=============================================================================
MONTH DETAIL MODAL
=============================================================================
Shows detailed booking analysis when clicking on a month row:
- Booking Velocity/Takeup by booking month
- Room Type Distribution  
- Lead Time Distribution
- Market/Channel Distribution
=============================================================================
-->

<!-- Modal Container - Add to your template -->
<div id="monthDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeMonthModal()"></div>
    
    <!-- Modal Content -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between">
                <div>
                    <h2 id="modalTitle" class="text-xl font-bold text-white">January 2026 Details</h2>
                    <p id="modalSubtitle" class="text-blue-100 text-sm">Booking analysis and distribution</p>
                </div>
                <button onclick="closeMonthModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <!-- Summary Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-xl p-4 text-center">
                        <div id="modalRevenue" class="text-2xl font-bold text-blue-600">$58,070</div>
                        <div class="text-sm text-gray-600">Revenue</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 text-center">
                        <div id="modalRoomNights" class="text-2xl font-bold text-green-600">255</div>
                        <div class="text-sm text-gray-600">Room Nights</div>
                    </div>
                    <div class="bg-amber-50 rounded-xl p-4 text-center">
                        <div id="modalOccupancy" class="text-2xl font-bold text-amber-600">45.7%</div>
                        <div class="text-sm text-gray-600">Occupancy</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 text-center">
                        <div id="modalADR" class="text-2xl font-bold text-purple-600">$227.73</div>
                        <div class="text-sm text-gray-600">ADR</div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8">
                        <button onclick="showTab('velocity')" id="tab-velocity" 
                                class="tab-btn py-3 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                            Booking Velocity
                        </button>
                        <button onclick="showTab('rooms')" id="tab-rooms"
                                class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                            Room Distribution
                        </button>
                        <button onclick="showTab('leadtime')" id="tab-leadtime"
                                class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                            Lead Time
                        </button>
                        <button onclick="showTab('market')" id="tab-market"
                                class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                            Market Distribution
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content: Booking Velocity -->
                <div id="content-velocity" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Booking Velocity by Month</h3>
                    <p class="text-sm text-gray-600 mb-4">Shows when bookings were made for this arrival month</p>
                    
                    <!-- Velocity Chart -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <canvas id="velocityChart" height="200"></canvas>
                    </div>
                    
                    <!-- Velocity Table -->
                    <div class="overflow-hidden rounded-xl border border-gray-200">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Booking Month</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">New Bookings</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Cancellations</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Net Pickup</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Cumulative OTB</th>
                                </tr>
                            </thead>
                            <tbody id="velocityTableBody" class="divide-y divide-gray-200">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab Content: Room Distribution -->
                <div id="content-rooms" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Room Type Distribution</h3>
                    <p class="text-sm text-gray-600 mb-4">Breakdown of bookings by room type</p>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Pie Chart -->
                        <div class="bg-gray-50 rounded-xl p-4">
                            <canvas id="roomsChart" height="250"></canvas>
                        </div>
                        
                        <!-- Room Table -->
                        <div class="overflow-hidden rounded-xl border border-gray-200">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Room Type</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Room Nights</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Revenue</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Share</th>
                                    </tr>
                                </thead>
                                <tbody id="roomsTableBody" class="divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Content: Lead Time Distribution -->
                <div id="content-leadtime" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lead Time Distribution</h3>
                    <p class="text-sm text-gray-600 mb-4">How far in advance guests booked their stay</p>
                    
                    <!-- Lead Time Chart -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <canvas id="leadTimeChart" height="200"></canvas>
                    </div>
                    
                    <!-- Lead Time Table -->
                    <div class="overflow-hidden rounded-xl border border-gray-200">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Lead Time</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Bookings</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Room Nights</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Avg ADR</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Share</th>
                                </tr>
                            </thead>
                            <tbody id="leadTimeTableBody" class="divide-y divide-gray-200">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab Content: Market Distribution -->
                <div id="content-market" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Market & Channel Distribution</h3>
                    <p class="text-sm text-gray-600 mb-4">Breakdown by booking channel and guest origin</p>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Channel Distribution -->
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">By Channel</h4>
                            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                <canvas id="channelChart" height="200"></canvas>
                            </div>
                            <div class="overflow-hidden rounded-xl border border-gray-200">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Channel</th>
                                            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600">Nights</th>
                                            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600">Share</th>
                                        </tr>
                                    </thead>
                                    <tbody id="channelTableBody" class="divide-y divide-gray-200 text-sm">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Country Distribution -->
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">By Country</h4>
                            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                <canvas id="countryChart" height="200"></canvas>
                            </div>
                            <div class="overflow-hidden rounded-xl border border-gray-200">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Country</th>
                                            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600">Nights</th>
                                            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600">Share</th>
                                        </tr>
                                    </thead>
                                    <tbody id="countryTableBody" class="divide-y divide-gray-200 text-sm">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Modal -->
<script>
// Store chart instances for cleanup
let velocityChartInstance = null;
let roomsChartInstance = null;
let leadTimeChartInstance = null;
let channelChartInstance = null;
let countryChartInstance = null;

// Month data endpoint URL (set this in your template)
// const monthDetailUrl = "{% url 'pricing:month_detail_api' org_code=org.code prop_code=property.code %}";

function openMonthModal(month, year) {
    // Show modal
    document.getElementById('monthDetailModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Update title
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('modalTitle').textContent = monthNames[month - 1] + ' ' + year + ' Details';
    
    // Fetch data from API
    fetch(`${monthDetailUrl}?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            populateModal(data);
        })
        .catch(error => {
            console.error('Error fetching month details:', error);
        });
}

function closeMonthModal() {
    document.getElementById('monthDetailModal').classList.add('hidden');
    document.body.style.overflow = '';
    
    // Destroy charts to prevent memory leaks
    if (velocityChartInstance) velocityChartInstance.destroy();
    if (roomsChartInstance) roomsChartInstance.destroy();
    if (leadTimeChartInstance) leadTimeChartInstance.destroy();
    if (channelChartInstance) channelChartInstance.destroy();
    if (countryChartInstance) countryChartInstance.destroy();
}

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Activate selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-blue-500', 'text-blue-600');
}

function populateModal(data) {
    // Update summary cards
    document.getElementById('modalRevenue').textContent = '$' + data.summary.revenue.toLocaleString();
    document.getElementById('modalRoomNights').textContent = data.summary.room_nights.toLocaleString();
    document.getElementById('modalOccupancy').textContent = data.summary.occupancy.toFixed(1) + '%';
    document.getElementById('modalADR').textContent = '$' + data.summary.adr.toFixed(2);
    
    // Populate Velocity Tab
    populateVelocityTab(data.velocity);
    
    // Populate Rooms Tab
    populateRoomsTab(data.room_distribution);
    
    // Populate Lead Time Tab
    populateLeadTimeTab(data.lead_time);
    
    // Populate Market Tab
    populateMarketTab(data.channel_distribution, data.country_distribution);
    
    // Show first tab
    showTab('velocity');
}

function populateVelocityTab(velocity) {
    // Build table
    const tbody = document.getElementById('velocityTableBody');
    tbody.innerHTML = '';
    
    let cumulative = 0;
    velocity.forEach(row => {
        cumulative += row.net_pickup;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${row.booking_month}</td>
            <td class="px-4 py-3 text-sm text-right text-green-600">+${row.new_bookings}</td>
            <td class="px-4 py-3 text-sm text-right text-red-600">${row.cancellations > 0 ? '-' + row.cancellations : '-'}</td>
            <td class="px-4 py-3 text-sm text-right font-medium ${row.net_pickup >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${row.net_pickup >= 0 ? '+' : ''}${row.net_pickup}
            </td>
            <td class="px-4 py-3 text-sm text-right font-semibold text-gray-900">${cumulative}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Build chart
    const ctx = document.getElementById('velocityChart').getContext('2d');
    if (velocityChartInstance) velocityChartInstance.destroy();
    
    velocityChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: velocity.map(v => v.booking_month),
            datasets: [
                {
                    label: 'New Bookings',
                    data: velocity.map(v => v.new_bookings),
                    backgroundColor: '#10b981',
                },
                {
                    label: 'Cancellations',
                    data: velocity.map(v => -v.cancellations),
                    backgroundColor: '#ef4444',
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function populateRoomsTab(rooms) {
    // Build table
    const tbody = document.getElementById('roomsTableBody');
    tbody.innerHTML = '';
    
    const total = rooms.reduce((sum, r) => sum + r.room_nights, 0);
    
    rooms.forEach(row => {
        const share = total > 0 ? (row.room_nights / total * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${row.room_type}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${row.room_nights}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">$${row.revenue.toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-600">${share}%</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Build chart
    const ctx = document.getElementById('roomsChart').getContext('2d');
    if (roomsChartInstance) roomsChartInstance.destroy();
    
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
    
    roomsChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: rooms.map(r => r.room_type),
            datasets: [{
                data: rooms.map(r => r.room_nights),
                backgroundColor: colors.slice(0, rooms.length),
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function populateLeadTimeTab(leadTime) {
    // Build table
    const tbody = document.getElementById('leadTimeTableBody');
    tbody.innerHTML = '';
    
    const total = leadTime.reduce((sum, r) => sum + r.bookings, 0);
    
    leadTime.forEach(row => {
        const share = total > 0 ? (row.bookings / total * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${row.bucket}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${row.bookings}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">${row.room_nights}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">$${row.avg_adr.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-right text-gray-600">${share}%</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Build chart
    const ctx = document.getElementById('leadTimeChart').getContext('2d');
    if (leadTimeChartInstance) leadTimeChartInstance.destroy();
    
    leadTimeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: leadTime.map(l => l.bucket),
            datasets: [{
                label: 'Bookings',
                data: leadTime.map(l => l.bookings),
                backgroundColor: '#3b82f6',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function populateMarketTab(channels, countries) {
    // Channels table
    const channelBody = document.getElementById('channelTableBody');
    channelBody.innerHTML = '';
    
    const channelTotal = channels.reduce((sum, c) => sum + c.room_nights, 0);
    
    channels.forEach(row => {
        const share = channelTotal > 0 ? (row.room_nights / channelTotal * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-4 py-2 text-gray-900">${row.channel}</td>
            <td class="px-4 py-2 text-right text-gray-900">${row.room_nights}</td>
            <td class="px-4 py-2 text-right text-gray-600">${share}%</td>
        `;
        channelBody.appendChild(tr);
    });
    
    // Countries table
    const countryBody = document.getElementById('countryTableBody');
    countryBody.innerHTML = '';
    
    const countryTotal = countries.reduce((sum, c) => sum + c.room_nights, 0);
    
    countries.forEach(row => {
        const share = countryTotal > 0 ? (row.room_nights / countryTotal * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-4 py-2 text-gray-900">${row.country}</td>
            <td class="px-4 py-2 text-right text-gray-900">${row.room_nights}</td>
            <td class="px-4 py-2 text-right text-gray-600">${share}%</td>
        `;
        countryBody.appendChild(tr);
    });
    
    // Build charts
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
    
    // Channel chart
    const channelCtx = document.getElementById('channelChart').getContext('2d');
    if (channelChartInstance) channelChartInstance.destroy();
    
    channelChartInstance = new Chart(channelCtx, {
        type: 'doughnut',
        data: {
            labels: channels.map(c => c.channel),
            datasets: [{
                data: channels.map(c => c.room_nights),
                backgroundColor: colors.slice(0, channels.length),
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
        }
    });
    
    // Country chart
    const countryCtx = document.getElementById('countryChart').getContext('2d');
    if (countryChartInstance) countryChartInstance.destroy();
    
    countryChartInstance = new Chart(countryCtx, {
        type: 'doughnut',
        data: {
            labels: countries.map(c => c.country),
            datasets: [{
                data: countries.map(c => c.room_nights),
                backgroundColor: colors.slice(0, countries.length),
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
        }
    });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMonthModal();
    }
});
</script>

<style>
/* Modal animation */
#monthDetailModal {
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#monthDetailModal > div:last-child {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>