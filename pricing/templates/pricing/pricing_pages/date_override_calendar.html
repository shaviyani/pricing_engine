{% extends "pricing/base.html" %}
{% load humanize %}

{% block title %}Rate Calendar - {{ month_name }} {{ year }} | {{ hotel.name }}{% endblock %}

{% block extra_css %}
<style>
    /* =========================================
       MOBILE-FIRST CALENDAR STYLES
       ========================================= */
    
    /* Calendar Grid - Mobile First */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e5e7eb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .calendar-header {
        background: #f9fafb;
        padding: 8px 4px;
        text-align: center;
        font-weight: 600;
        font-size: 10px;
        color: #6b7280;
        text-transform: uppercase;
    }
    
    .calendar-day {
        background: white;
        min-height: 70px;
        padding: 4px;
        position: relative;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        flex-direction: column;
    }
    
    .calendar-day:hover {
        background: #f9fafb;
    }
    
    .calendar-day.empty {
        background: #f9fafb;
        cursor: default;
    }
    
    .calendar-day.today {
        background: #eff6ff;
    }
    
    .calendar-day.past {
        opacity: 0.5;
    }
    
    .calendar-day.has-override {
        border-left: 2px solid #3b82f6;
    }
    
    .calendar-day.has-override.increase {
        border-left-color: #22c55e;
        background: linear-gradient(135deg, #f0fdf4 0%, white 50%);
    }
    
    .calendar-day.has-override.decrease {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, white 50%);
    }
    
    /* Day Number */
    .day-number {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        line-height: 1;
    }
    
    .calendar-day.today .day-number {
        background: #3b82f6;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
    }
    
    /* Season - Hidden on mobile */
    .day-season {
        display: none;
    }
    
    /* Rate */
    .day-rate {
        margin-top: auto;
        font-size: 11px;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.2;
    }
    
    .day-rate.loading {
        color: #d1d5db;
    }
    
    /* Override Badge - Compact on mobile */
    .day-override-badge {
        padding: 1px 3px;
        border-radius: 2px;
        font-size: 8px;
        font-weight: 600;
        display: inline-block;
        margin-top: 2px;
    }
    
    .day-override-badge.increase {
        background: #dcfce7;
        color: #166534;
    }
    
    .day-override-badge.decrease {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* Occupancy Bar - Simplified on mobile */
    .occupancy-container {
        margin-top: auto;
        padding-top: 4px;
    }
    
    .occupancy-bar-bg {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .occupancy-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .occupancy-bar.low { background: #22c55e; }
    .occupancy-bar.medium { background: #f59e0b; }
    .occupancy-bar.high { background: #ef4444; }
    .occupancy-bar.full { background: #dc2626; }
    
    /* Hide label on mobile */
    .occupancy-label {
        display: none;
    }
    
    /* Tooltip - Touch friendly */
    .occupancy-tooltip {
        display: none;
    }
    
    /* =========================================
       TABLET & DESKTOP STYLES (min-width: 640px)
       ========================================= */
    @media (min-width: 640px) {
        .calendar-header {
            padding: 12px 8px;
            font-size: 12px;
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 8px;
        }
        
        .day-number {
            font-size: 14px;
        }
        
        .calendar-day.today .day-number {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }
        
        .day-season {
            display: block;
            font-size: 10px;
            color: #9ca3af;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .day-rate {
            margin-top: 6px;
            font-size: 15px;
        }
        
        .day-override-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 4px;
        }
        
        .occupancy-container {
            padding-top: 6px;
        }
        
        .occupancy-bar-bg {
            height: 6px;
            border-radius: 3px;
        }
        
        .occupancy-label {
            display: block;
            font-size: 9px;
            color: #6b7280;
            margin-top: 2px;
            text-align: right;
        }
    }
    
    /* =========================================
       DESKTOP STYLES (min-width: 1024px)
       ========================================= */
    @media (min-width: 1024px) {
        .calendar-day {
            min-height: 110px;
        }
        
        .occupancy-tooltip {
            display: block;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            margin-bottom: 8px;
        }
        
        .occupancy-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }
        
        .occupancy-container:hover .occupancy-tooltip {
            opacity: 1;
            visibility: visible;
        }
    }
    
    /* =========================================
       FILTERS - Mobile Optimized
       ========================================= */
    .calendar-filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 100px;
    }
    
    .filter-item label {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
    }
    
    .filter-item select {
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        width: 100%;
    }
    
    .filter-item select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    @media (min-width: 640px) {
        .filter-item {
            flex-direction: row;
            align-items: center;
            flex: none;
            min-width: auto;
        }
        
        .filter-item label {
            font-size: 13px;
            font-weight: 500;
            text-transform: none;
        }
        
        .filter-item select {
            min-width: 140px;
            width: auto;
        }
    }
    
    /* =========================================
       SIDEBAR - Hidden on mobile, shown on desktop
       ========================================= */
    .sidebar-section {
        display: none;
    }
    
    @media (min-width: 1024px) {
        .sidebar-section {
            display: block;
        }
    }
    
    .override-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .override-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-decoration: none;
    }
    
    .override-item:hover {
        border-color: #3b82f6;
    }
    
    .override-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .override-badge.increase {
        background: #dcfce7;
        color: #166534;
    }
    
    .override-badge.decrease {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .priority-badge {
        background: #f3f4f6;
        color: #6b7280;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .priority-badge.high {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* =========================================
       LEGEND - Compact on mobile
       ========================================= */
    .legend {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        font-size: 11px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: #6b7280;
    }
    
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    .legend-color.increase {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        border-left: 2px solid #22c55e;
    }
    
    .legend-color.decrease {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        border-left: 2px solid #ef4444;
    }
    
    .legend-color.today {
        background: #eff6ff;
        border: 2px solid #3b82f6;
    }
    
    .legend-separator {
        width: 1px;
        height: 16px;
        background: #e5e7eb;
    }
    
    .legend-bar {
        width: 20px;
        height: 4px;
        border-radius: 2px;
    }
    
    .legend-bar.low { background: #22c55e; }
    .legend-bar.medium { background: #f59e0b; }
    .legend-bar.high { background: #ef4444; }
    
    @media (min-width: 640px) {
        .legend {
            gap: 16px;
            font-size: 12px;
        }
        
        .legend-item {
            gap: 6px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
        }
        
        .legend-bar {
            width: 24px;
            height: 6px;
            border-radius: 3px;
        }
    }
    
    /* =========================================
       MODAL - Full screen on mobile
       ========================================= */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: white;
        border-radius: 16px 16px 0 0;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    
    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }
    
    .modal-header {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
    }
    
    .modal-drag-handle {
        width: 40px;
        height: 4px;
        background: #d1d5db;
        border-radius: 2px;
        margin: 0 auto 12px;
    }
    
    .modal-filters {
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
    }
    
    .modal-body {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        -webkit-overflow-scrolling: touch;
    }
    
    @media (min-width: 640px) {
        .modal-overlay {
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            border-radius: 12px;
            max-width: 900px;
            max-height: 85vh;
            transform: scale(0.95);
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-drag-handle {
            display: none;
        }
        
        .modal-header {
            padding: 20px 24px;
        }
        
        .modal-filters {
            padding: 16px 24px;
        }
        
        .modal-body {
            padding: 20px 24px;
        }
    }
    
    /* Modal Filter Group */
    .filter-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .modal-filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 120px;
    }
    
    .modal-filter-item label {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
    }
    
    .modal-filter-item select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        width: 100%;
    }
    
    @media (min-width: 640px) {
        .modal-filter-item {
            flex: none;
            min-width: 180px;
        }
    }
    
    /* =========================================
       RATE TABLE - Responsive
       ========================================= */
    .rate-section {
        margin-bottom: 20px;
    }
    
    .rate-section:last-child {
        margin-bottom: 0;
    }
    
    .rate-section-title {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .rate-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
    }
    
    .rate-table th {
        text-align: left;
        padding: 8px;
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .rate-table th.text-right {
        text-align: right;
    }
    
    .rate-table td {
        padding: 8px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .rate-table tr:active {
        background: #f3f4f6;
    }
    
    .rate-value {
        font-weight: 600;
        color: #1f2937;
        text-align: right;
    }
    
    .bar-value {
        color: #6b7280;
        text-align: right;
    }
    
    .override-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-left: 4px;
    }
    
    .override-dot.increase { background: #22c55e; }
    .override-dot.decrease { background: #ef4444; }
    
    @media (min-width: 640px) {
        .rate-table {
            font-size: 13px;
        }
        
        .rate-table th,
        .rate-table td {
            padding: 10px 12px;
        }
        
        .rate-table tr:hover {
            background: #f9fafb;
        }
        
        .override-dot {
            width: 8px;
            height: 8px;
            margin-left: 6px;
        }
    }
    
    /* =========================================
       HEADER - Mobile Optimized
       ========================================= */
    .page-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .page-header h1 {
        font-size: 20px;
    }
    
    .page-header .add-btn {
        align-self: flex-start;
        padding: 8px 16px;
        font-size: 13px;
    }
    
    @media (min-width: 640px) {
        .page-header {
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .page-header h1 {
            font-size: 24px;
        }
    }
    
    /* Month Navigation - Touch Friendly */
    .month-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }
    
    .month-nav a {
        padding: 10px;
        border-radius: 8px;
        touch-action: manipulation;
    }
    
    .month-nav a:active {
        background: #e5e7eb;
    }
    
    /* =========================================
       SPINNER
       ========================================= */
    .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    .spinner-small {
        width: 16px;
        height: 16px;
        border-width: 2px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-results {
        text-align: center;
        padding: 32px 16px;
        color: #6b7280;
    }
    
    /* Tooltip helpers */
    .tooltip-row {
        display: flex;
        justify-content: space-between;
        gap: 16px;
    }
    
    .tooltip-row + .tooltip-row {
        margin-top: 4px;
    }
    
    .tooltip-label { color: #9ca3af; }
    .tooltip-value { font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

<div class="space-y-4 sm:space-y-6">
    
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Rate Calendar</h1>
            <p class="text-gray-600 text-sm mt-1">
                {{ hotel.name }}
            </p>
        </div>
        <a href="{% url 'admin:pricing_daterateoverride_add' %}?hotel={{ hotel.pk }}" 
           class="add-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
            + Add Override
        </a>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6">
        
        <!-- Calendar Section -->
        <div class="lg:col-span-3 space-y-4">
            
            <!-- Month Navigation + Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="month-nav">
                    <a href="?year={{ prev_year }}&month={{ prev_month }}" 
                       class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    
                    <div class="text-center">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900">{{ month_name }} {{ year }}</h2>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">
                            {{ override_stats.override_days }} override{{ override_stats.override_days|pluralize }}
                        </p>
                    </div>
                    
                    <a href="?year={{ next_year }}&month={{ next_month }}" 
                       class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </a>
                </div>
                
                <!-- Filters -->
                <div class="pt-4 border-t border-gray-200">
                    <div class="calendar-filters">
                        <div class="filter-item">
                            <label for="calendarRoom">Room</label>
                            <select id="calendarRoom" onchange="loadCalendarRates()">
                                <option value="">Lowest</option>
                                {% for room in room_types %}
                                <option value="{{ room.id }}">{{ room.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="calendarChannel">Channel</label>
                            <select id="calendarChannel" onchange="loadCalendarRates()">
                                {% for channel in channels %}
                                <option value="{{ channel.id }}" {% if channel.name == "OTA" or "OTA" in channel.name %}selected{% endif %}>{{ channel.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="calendarRatePlan">Plan</label>
                            <select id="calendarRatePlan" onchange="loadCalendarRates()">
                                {% for plan in rate_plans %}
                                <option value="{{ plan.id }}" {% if "Breakfast" in plan.name or "B&B" in plan.name %}selected{% endif %}>{{ plan.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="ratesLoading" class="hidden self-end pb-2">
                            <div class="spinner spinner-small"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 sm:p-4">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color increase"></div>
                        <span>Increase</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color decrease"></div>
                        <span>Decrease</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color today"></div>
                        <span>Today</span>
                    </div>
                    <div class="legend-separator"></div>
                    <div class="legend-item">
                        <div class="legend-bar low"></div>
                        <span>&lt;50%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bar medium"></div>
                        <span>50-80%</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bar high"></div>
                        <span>&gt;80%</span>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Grid -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="calendar-grid">
                    <!-- Header Row -->
                    {% for day_name in weekdays %}
                    <div class="calendar-header">{{ day_name|slice:":3" }}</div>
                    {% endfor %}
                    
                    <!-- Day Cells -->
                    {% for week in calendar_weeks %}
                        {% for day in week %}
                            {% if day.day %}
                                <div class="calendar-day {% if day.is_today %}today{% endif %} {% if day.is_past %}past{% endif %}"
                                     id="day-{{ day.date|date:'Y-m-d' }}"
                                     data-date="{{ day.date|date:'Y-m-d' }}"
                                     onclick="showDateRates('{{ day.date|date:'Y-m-d' }}')">
                                    
                                    <div class="day-number">{{ day.day }}</div>
                                    
                                    {% if day.season %}
                                    <div class="day-season" title="{{ day.season.name }}">
                                        {{ day.season.name }}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="day-rate loading" id="rate-{{ day.date|date:'Y-m-d' }}">—</div>
                                    
                                    <div id="override-{{ day.date|date:'Y-m-d' }}"></div>
                                    
                                    <div class="occupancy-container" id="occupancy-{{ day.date|date:'Y-m-d' }}">
                                        <div class="occupancy-bar-bg">
                                            <div class="occupancy-bar low" style="width: 0%"></div>
                                        </div>
                                        <div class="occupancy-label">0%</div>
                                        <div class="occupancy-tooltip">
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Occupancy:</span>
                                                <span class="tooltip-value occ-percent">0%</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Occupied:</span>
                                                <span class="tooltip-value occ-occupied">0</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Available:</span>
                                                <span class="tooltip-value occ-available">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="calendar-day empty"></div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar - Desktop Only -->
        <div class="sidebar-section space-y-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-4">Active Overrides</h3>
                
                {% if active_overrides %}
                <div class="override-list">
                    {% for override in active_overrides %}
                    <a href="{% url 'admin:pricing_daterateoverride_change' override.pk %}" 
                       class="override-item">
                        <div>
                            <div class="font-medium text-gray-900 text-sm">{{ override.name }}</div>
                            <div class="text-xs text-gray-500 mt-1">{{ override.get_periods_display }}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="override-badge {% if override.adjustment > 0 %}increase{% else %}decrease{% endif %}">
                                {{ override.get_adjustment_display }}
                            </span>
                            <span class="priority-badge {% if override.priority >= 80 %}high{% endif %}">
                                P{{ override.priority }}
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No active overrides</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- Modal -->
<div id="ratesModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-drag-handle"></div>
            <div class="flex items-center justify-between">
                <div>
                    <h3 id="modalTitle" class="text-lg sm:text-xl font-bold text-gray-900"></h3>
                    <p id="modalSubtitle" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-lg -mr-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="modal-filters">
            <div class="filter-group">
                <div class="modal-filter-item">
                    <label>Room Type</label>
                    <select id="filterRoom" onchange="applyModalFilters()">
                        <option value="">All Rooms</option>
                        {% for room in room_types %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-filter-item">
                    <label>Channel</label>
                    <select id="filterChannel" onchange="applyModalFilters()">
                        <option value="">All Channels</option>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}">{{ channel.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div class="modal-body" id="modalBody">
            <div class="text-center py-12">
                <div class="spinner"></div>
                <p class="text-gray-500 mt-4">Loading...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
var currentYear = {{ year }};
var currentMonth = {{ month }};
var currentModalData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCalendarRates();
});

function loadCalendarRates() {
    var roomId = document.getElementById('calendarRoom').value;
    var channelId = document.getElementById('calendarChannel').value;
    var ratePlanId = document.getElementById('calendarRatePlan').value;
    var loadingEl = document.getElementById('ratesLoading');
    
    loadingEl.classList.remove('hidden');
    
    var rateEls = document.querySelectorAll('.day-rate');
    for (var i = 0; i < rateEls.length; i++) {
        rateEls[i].textContent = '—';
        rateEls[i].classList.add('loading');
    }
    
    var overrideEls = document.querySelectorAll('[id^="override-"]');
    for (var i = 0; i < overrideEls.length; i++) {
        overrideEls[i].innerHTML = '';
    }
    
    var url = '/{{ org_code }}/{{ prop_code }}/api/calendar-rates/' +
        '?year=' + currentYear +
        '&month=' + currentMonth +
        '&channel_id=' + channelId +
        '&rate_plan_id=' + ratePlanId;
    
    if (roomId) url += '&room_type_id=' + roomId;
    
    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loadingEl.classList.add('hidden');
            updateCalendarRates(data);
        })
        .catch(function(e) {
            console.error(e);
            loadingEl.classList.add('hidden');
        });
}

function updateCalendarRates(data) {
    var rates = data.rates;
    
    for (var dateStr in rates) {
        var d = rates[dateStr];
        var rateEl = document.getElementById('rate-' + dateStr);
        var overrideEl = document.getElementById('override-' + dateStr);
        var dayEl = document.getElementById('day-' + dateStr);
        var occEl = document.getElementById('occupancy-' + dateStr);
        
        if (rateEl) {
            rateEl.classList.remove('loading');
            rateEl.textContent = d.rate ? '$' + d.rate : '—';
        }
        
        if (overrideEl && d.has_override) {
            var cls = d.is_increase ? 'increase' : 'decrease';
            overrideEl.innerHTML = '<span class="day-override-badge ' + cls + '">' + d.override_adjustment + '</span>';
        }
        
        if (dayEl) {
            dayEl.classList.remove('has-override', 'increase', 'decrease');
            if (d.has_override) {
                dayEl.classList.add('has-override', d.is_increase ? 'increase' : 'decrease');
            }
        }
        
        if (occEl && d.occupancy) {
            var occ = d.occupancy;
            var bar = occEl.querySelector('.occupancy-bar');
            var label = occEl.querySelector('.occupancy-label');
            
            bar.style.width = occ.percent + '%';
            bar.classList.remove('low', 'medium', 'high', 'full');
            if (occ.percent >= 100) bar.classList.add('full');
            else if (occ.percent >= 80) bar.classList.add('high');
            else if (occ.percent >= 50) bar.classList.add('medium');
            else bar.classList.add('low');
            
            if (label) label.textContent = occ.percent + '%';
            
            var tp = occEl.querySelector('.occ-percent');
            var to = occEl.querySelector('.occ-occupied');
            var ta = occEl.querySelector('.occ-available');
            if (tp) tp.textContent = occ.percent + '%';
            if (to) to.textContent = occ.rooms_occupied;
            if (ta) ta.textContent = occ.rooms_available;
        }
    }
}

function showDateRates(dateStr) {
    var modal = document.getElementById('ratesModal');
    var modalTitle = document.getElementById('modalTitle');
    var modalSubtitle = document.getElementById('modalSubtitle');
    var modalBody = document.getElementById('modalBody');
    
    document.getElementById('filterRoom').value = '';
    document.getElementById('filterChannel').value = '';
    
    var dateObj = new Date(dateStr + 'T00:00:00');
    var opts = { weekday: 'short', month: 'short', day: 'numeric' };
    modalTitle.textContent = dateObj.toLocaleDateString('en-US', opts);
    modalSubtitle.textContent = 'Loading...';
    modalBody.innerHTML = '<div class="text-center py-12"><div class="spinner"></div></div>';
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    fetch('/{{ org_code }}/{{ prop_code }}/api/date-rate-detail/?date=' + dateStr)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            currentModalData = data;
            renderModalRates(data, '', '');
        })
        .catch(function(e) {
            console.error(e);
            modalBody.innerHTML = '<div class="no-results">Error loading rates</div>';
        });
}

function applyModalFilters() {
    if (!currentModalData) return;
    renderModalRates(currentModalData, 
        document.getElementById('filterRoom').value,
        document.getElementById('filterChannel').value);
}

function renderModalRates(data, roomFilter, channelFilter) {
    var modalSubtitle = document.getElementById('modalSubtitle');
    var modalBody = document.getElementById('modalBody');
    
    if (data.error) {
        modalBody.innerHTML = '<div class="no-results">' + data.error + '</div>';
        return;
    }
    
    var season = data.season;
    var override = data.override;
    var rates = data.rates;
    
    modalSubtitle.textContent = season ? season.name + ' • ' + season.index : 'No Season';
    
    var html = '';
    
    if (override) {
        var isInc = override.adjustment_value && parseFloat(override.adjustment_value) >= 0;
        html += '<div class="mb-4 p-3 rounded-lg ' + (isInc ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200') + '">';
        html += '<div class="flex items-center justify-between text-sm">';
        html += '<span class="font-medium">' + override.name + '</span>';
        html += '<span class="font-bold ' + (isInc ? 'text-green-600' : 'text-red-600') + '">' + override.adjustment + '</span>';
        html += '</div></div>';
    }
    
    if (!rates || !rates.length) {
        html += '<div class="no-results">No rates available</div>';
        modalBody.innerHTML = html;
        return;
    }
    
    var isInc = override && override.adjustment_value && parseFloat(override.adjustment_value) >= 0;
    var hasResults = false;
    
    for (var i = 0; i < rates.length; i++) {
        var room = rates[i];
        if (roomFilter && room.room_type_id != roomFilter) continue;
        
        var filtered = [];
        for (var j = 0; j < room.rates.length; j++) {
            var r = room.rates[j];
            if (!channelFilter || r.channel_id == channelFilter) filtered.push(r);
        }
        if (!filtered.length) continue;
        
        hasResults = true;
        html += '<div class="rate-section">';
        html += '<div class="rate-section-title">' + room.room_type_name + '</div>';
        html += '<table class="rate-table"><thead><tr>';
        html += '<th>Plan</th><th>Channel</th><th class="text-right">BAR</th><th class="text-right">Rate</th>';
        html += '</tr></thead><tbody>';
        
        for (var j = 0; j < filtered.length; j++) {
            var r = filtered[j];
            html += '<tr><td>' + r.rate_plan_name + '</td><td>' + r.channel_name + '</td>';
            html += '<td class="bar-value">$' + r.bar_rate + '</td>';
            html += '<td class="rate-value">$' + r.final_rate;
            if (r.override_applied) html += '<span class="override-dot ' + (isInc ? 'increase' : 'decrease') + '"></span>';
            html += '</td></tr>';
        }
        html += '</tbody></table></div>';
    }
    
    if (!hasResults) html += '<div class="no-results">No matching rates</div>';
    modalBody.innerHTML = html;
}

function closeModal(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('ratesModal').classList.remove('active');
    document.body.style.overflow = '';
    currentModalData = null;
}

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });
</script>
{% endblock %}