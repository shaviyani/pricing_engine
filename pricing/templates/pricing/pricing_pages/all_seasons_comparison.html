{% extends 'pricing/base.html' %}
{% load pricing_filters %}

{% block title %}All Seasons Comparison - Enhanced{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">All Seasons Comparison (Enhanced)</h1>
            <p class="text-gray-600 mt-1">Compare all rate modifiers across seasons</p>
        </div>
        <div class="flex space-x-2">
            <a href="{% url 'pricing:enhanced_matrix' %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                Single Season View
            </a>
            <a href="{% url 'pricing:home' %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Home
            </a>
        </div>
    </div>

    {% if not has_data %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <h3 class="mt-2 text-lg font-medium text-gray-900">No Data Available</h3>
        <p class="mt-1 text-sm text-gray-500">Load sample data to see the comparison.</p>
        <div class="mt-6">
            <a href="{% url 'admin:index' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                Go to Admin
            </a>
        </div>
    </div>
    {% else %}

    <!-- Info Banner -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm text-blue-900">
                <span class="font-semibold">Enhanced view</span> showing all rate modifiers across {{ seasons.count }} seasons.
                {% if selected_rate_plan_id %}
                    Filtered to: <strong>{{ rate_plans.first.name }}</strong>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">Filter by Rate Plan</label>
            <div class="flex items-center space-x-2">
                <select id="ratePlanFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Rate Plans</option>
                    {% for plan in all_rate_plans %}
                    <option value="{{ plan.id }}" {% if selected_rate_plan_id == plan.id|stringformat:"s" %}selected{% endif %}>
                        {{ plan.name }}
                    </option>
                    {% endfor %}
                </select>
                {% if selected_rate_plan_id %}
                <a href="?" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                    Clear Filter
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Comparison by Channel -->
    <div class="space-y-8">
        {% for channel in channels %}
        {% with channel_matrix=matrix|get_item:channel.id channel_stat=channel_stats|get_item:channel.id %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Channel Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">{{ channel.name }}</h2>
                        <div class="flex items-center space-x-4 mt-2 text-sm">
                            {% if channel.base_discount_percent > 0 %}
                                <span class="inline-flex items-center px-2 py-1 rounded bg-green-100 text-green-800 font-medium">
                                    {{ channel.base_discount_percent }}% Base Discount
                                </span>
                            {% endif %}
                            {% if channel.commission_percent > 0 %}
                                <span class="inline-flex items-center px-2 py-1 rounded bg-amber-100 text-amber-800 font-medium">
                                    {{ channel.commission_percent }}% Commission
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if channel_stat %}
                    <div class="text-right">
                        <div class="text-sm text-gray-600 mb-1">Price Range (All Modifiers)</div>
                        <div class="flex items-center space-x-3">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Lowest</div>
                                <div class="text-2xl font-bold text-green-600">${{ channel_stat.min_rate }}</div>
                            </div>
                            <div class="text-gray-400">‚Üí</div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Highest</div>
                                <div class="text-2xl font-bold text-amber-600">${{ channel_stat.max_rate }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="sticky left-0 z-10 bg-gray-50 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase border-r border-gray-200">
                                Room / Rate Plan / Modifier
                            </th>
                            {% for season in seasons %}
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                                <div class="font-semibold text-gray-900">{{ season.name }}</div>
                                <div class="text-xs text-gray-500 normal-case mt-1">{{ season.start_date|date:"M d" }} - {{ season.end_date|date:"M d" }}</div>
                                <div class="text-xs text-blue-600 mt-1">√ó{{ season.season_index }}</div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for room in rooms %}
                            {% with room_matrix=channel_matrix|get_item:room.id %}
                            {% if room_matrix %}
                                <!-- Room Type Header (Collapsible) -->
                                <tr class="bg-gradient-to-r from-blue-50 to-blue-100 border-t-2 border-blue-200 cursor-pointer hover:from-blue-100 hover:to-blue-150 transition" 
                                    onclick="toggleRoom('{{ channel.id }}-{{ room.id }}')">
                                    <td colspan="{{ seasons.count|add:1 }}" class="px-6 py-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <!-- Chevron Icon -->
                                                <svg class="w-5 h-5 text-blue-600 transform transition-transform duration-200" 
                                                     id="chevron-{{ channel.id }}-{{ room.id }}"
                                                     viewBox="0 0 24 24">
                                                    <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                                </svg>
                                                <div>
                                                    <span class="text-lg font-bold text-gray-900">{{ room.name }}</span>
                                                    <span class="text-sm text-gray-600 ml-2">({{ room.number_of_rooms }} rooms)</span>
                                                </div>
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                Click to expand/collapse
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Season Rate Ranges Row -->
                                <tr class="bg-white border-b border-gray-200">
                                    <td class="sticky left-0 z-10 bg-gray-100 px-6 py-2 text-xs font-medium text-gray-600 uppercase border-r border-gray-200">
                                        Rate Range
                                    </td>
                                    {% for season in seasons %}
                                    <td class="px-4 py-2 text-center bg-gray-50">
                                        <div class="space-y-1">
                                            <div class="text-xs text-gray-500">Low</div>
                                            <div class="text-sm font-bold text-green-600">
                                                $<span class="season-min" data-room="{{ channel.id }}-{{ room.id }}" data-season="{{ season.id }}">‚Äî</span>
                                            </div>
                                            <div class="text-xs text-gray-400">‚Üí</div>
                                            <div class="text-xs text-gray-500">High</div>
                                            <div class="text-sm font-bold text-amber-600">
                                                $<span class="season-max" data-room="{{ channel.id }}-{{ room.id }}" data-season="{{ season.id }}">‚Äî</span>
                                            </div>
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <!-- Collapsible Content -->
                                <tr id="room-{{ channel.id }}-{{ room.id }}" class="room-section">
                                    <td colspan="{{ seasons.count|add:1 }}" class="p-0">
                                        <div class="bg-gray-50">
                                            <table class="min-w-full">
                                                <tbody>
                                                {% for rate_plan in rate_plans %}
                                                    {% with plan_matrix=room_matrix|get_item:rate_plan.id %}
                                                    {% if plan_matrix %}
                                                        <!-- Rate Plan Subheader -->
                                                        <tr class="bg-gray-100">
                                                            <td colspan="{{ seasons.count|add:1 }}" class="px-8 py-2">
                                                                <div class="font-semibold text-gray-700">
                                                                    {{ rate_plan.name }}
                                                                    {% if rate_plan.meal_supplement > 0 %}
                                                                        <span class="text-sm text-gray-500">(+${{ rate_plan.meal_supplement }}/person)</span>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        
                                                        <!-- Modifier Rows -->
                                                        {% for modifier_id, modifier_data in plan_matrix.items %}
                                                        <tr class="hover:bg-blue-50 transition">
                                                            <td class="sticky left-0 z-10 bg-white px-8 py-3 text-sm border-r border-gray-200 w-64">
                                                                <div class="flex items-center space-x-2">
                                                                    <span class="text-lg">
                                                                        {% if modifier_data.modifier.modifier_type == 'member' %}üéØ
                                                                        {% elif modifier_data.modifier.modifier_type == 'mobile' %}üì±
                                                                        {% elif modifier_data.modifier.modifier_type == 'promo' %}üìß
                                                                        {% elif modifier_data.modifier.modifier_type == 'last_minute' %}‚ö°
                                                                        {% elif modifier_data.modifier.modifier_type == 'early_bird' %}üê¶
                                                                        {% elif modifier_data.modifier.modifier_type == 'corporate' %}üè¢
                                                                        {% else %}‚Ä¢{% endif %}
                                                                    </span>
                                                                    <div>
                                                                        <div class="font-medium text-gray-900">{{ modifier_data.modifier.name }}</div>
                                                                        {% if modifier_data.modifier.discount_percent > 0 %}
                                                                        <div class="text-xs text-gray-500">-{{ modifier_data.modifier.discount_percent }}%</div>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            {% for season in seasons %}
                                                                {% with season_data=modifier_data.seasons|get_item:season.id %}
                                                                {% if season_data %}
                                                                <td class="px-4 py-3 text-center tooltip-trigger relative">
                                                                    <span class="text-lg font-bold px-3 py-1 rounded-lg inline-block room-rate
                                                                        {% if season_data.is_min %}bg-green-100 text-green-800 border-2 border-green-300
                                                                        {% elif season_data.is_max %}bg-amber-100 text-amber-800 border-2 border-amber-300
                                                                        {% else %}text-gray-900{% endif %}"
                                                                        data-room="{{ channel.id }}-{{ room.id }}" 
                                                                        data-season="{{ season.id }}" 
                                                                        data-rate="{{ season_data.rate }}">
                                                                        ${{ season_data.rate }}
                                                                    </span>
                                                                    
                                                                    <!-- Tooltip -->
                                                                    <div class="tooltip absolute z-20 w-80 bg-gray-900 text-white text-xs rounded-lg shadow-lg p-4 left-1/2 transform -translate-x-1/2 top-full mt-2">
                                                                        <div class="font-semibold mb-1">{{ modifier_data.modifier.name }}</div>
                                                                        <div class="text-xs text-gray-400 mb-2">{{ room.name }} - {{ rate_plan.name }}</div>
                                                                        <div class="space-y-1">
                                                                            <div class="flex justify-between"><span>Base:</span><span>${{ season_data.breakdown.base_rate }}</span></div>
                                                                            <div class="flex justify-between"><span>√ó Season:</span><span>${{ season_data.breakdown.seasonal_rate }}</span></div>
                                                                            {% if season_data.breakdown.meal_cost > 0 %}
                                                                            <div class="flex justify-between"><span>+ Meals:</span><span>${{ season_data.breakdown.meal_cost }}</span></div>
                                                                            {% endif %}
                                                                            <div class="flex justify-between border-t border-gray-700 pt-1 font-semibold"><span>BAR:</span><span>${{ season_data.breakdown.bar_rate }}</span></div>
                                                                            {% if season_data.breakdown.modifier_discount_percent > 0 %}
                                                                            <div class="flex justify-between"><span>- Modifier:</span><span>-${{ season_data.breakdown.modifier_discount_amount }}</span></div>
                                                                            {% endif %}
                                                                            <div class="flex justify-between border-t border-gray-700 pt-1 font-bold text-green-300"><span>Guest Pays:</span><span>${{ season_data.breakdown.final_rate }}</span></div>
                                                                            {% if season_data.breakdown.commission_percent > 0 %}
                                                                            <div class="flex justify-between pt-2 border-t border-gray-700"><span>- Commission:</span><span class="text-red-300">-${{ season_data.breakdown.commission_amount }}</span></div>
                                                                            <div class="flex justify-between font-bold text-blue-300"><span>You Receive:</span><span>${{ season_data.breakdown.net_revenue }}</span></div>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                {% else %}
                                                                <td class="px-4 py-3 text-center text-gray-400">‚Äî</td>
                                                                {% endif %}
                                                                {% endwith %}
                                                            {% endfor %}
                                                        </tr>
                                                        {% endfor %}
                                                    {% endif %}
                                                    {% endwith %}
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Legend</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="flex items-start">
                <div class="w-8 h-8 bg-green-100 border-2 border-green-300 rounded mr-3"></div>
                <span class="text-gray-700"><span class="font-semibold">Green:</span> Lowest rate for this modifier</span>
            </div>
            <div class="flex items-start">
                <div class="w-8 h-8 bg-amber-100 border-2 border-amber-300 rounded mr-3"></div>
                <span class="text-gray-700"><span class="font-semibold">Amber:</span> Highest rate for this modifier</span>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sticky { position: sticky; }
    .overflow-x-auto { scrollbar-width: thin; }
    .tooltip { display: none; pointer-events: none; }
    .tooltip-trigger:hover .tooltip { display: block; }
    
    /* Collapsible sections */
    .room-section {
        display: table-row;
    }
    .room-section.collapsed {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Toggle room section collapse/expand
function toggleRoom(roomId) {
    const section = document.getElementById('room-' + roomId);
    const chevron = document.getElementById('chevron-' + roomId);
    
    if (section.classList.contains('collapsed')) {
        section.classList.remove('collapsed');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        section.classList.add('collapsed');
        chevron.style.transform = 'rotate(-90deg)';
    }
}

// Calculate min/max rates per season for each room
document.addEventListener('DOMContentLoaded', function() {
    const seasonRates = {}; // { "roomId-seasonId": { min, max } }
    
    // Collect all rates by room and season
    document.querySelectorAll('.room-rate').forEach(function(element) {
        const roomId = element.dataset.room;
        const seasonId = element.dataset.season;
        const rate = parseFloat(element.dataset.rate);
        const key = roomId + '-' + seasonId;
        
        if (!seasonRates[key]) {
            seasonRates[key] = { min: Infinity, max: -Infinity };
        }
        
        if (rate < seasonRates[key].min) seasonRates[key].min = rate;
        if (rate > seasonRates[key].max) seasonRates[key].max = rate;
    });
    
    // Update min/max displays for each season column
    document.querySelectorAll('.season-min').forEach(function(element) {
        const roomId = element.dataset.room;
        const seasonId = element.dataset.season;
        const key = roomId + '-' + seasonId;
        
        if (seasonRates[key]) {
            element.textContent = seasonRates[key].min.toFixed(2);
        }
    });
    
    document.querySelectorAll('.season-max').forEach(function(element) {
        const roomId = element.dataset.room;
        const seasonId = element.dataset.season;
        const key = roomId + '-' + seasonId;
        
        if (seasonRates[key]) {
            element.textContent = seasonRates[key].max.toFixed(2);
        }
    });
});

// Rate plan filter
document.getElementById('ratePlanFilter').addEventListener('change', function() {
    const url = new URL(window.location);
    this.value ? url.searchParams.set('rate_plan', this.value) : url.searchParams.delete('rate_plan');
    window.location.href = url.toString();
});
</script>
{% endblock %}