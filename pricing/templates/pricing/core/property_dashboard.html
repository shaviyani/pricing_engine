{% extends "pricing/base.html" %}
{% load humanize %}

{% block title %}{{ prop.name }} - Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ prop.name }}</h1>
                <p class="mt-1 text-sm text-gray-500">
                    {{ prop.location|default:"Property Dashboard" }} • {{ prop.total_rooms }} rooms
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'pricing:matrix' org_code=org.code prop_code=prop.code %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                    Pricing Matrix
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <!-- Seasons -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Seasons</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ stats.seasons_count }}</p>
                </div>
                <div class="p-3 bg-amber-100 rounded-lg">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Room Types -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Room Types</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ stats.rooms_count }}</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                </div>
            </div>
            <p class="mt-2 text-xs text-gray-500">{{ stats.room_inventory|intcomma }} total rooms</p>
        </div>

        <!-- Rate Plans -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Rate Plans</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ stats.rate_plans_count }}</p>
                </div>
                <div class="p-3 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Channels -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Channels</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ stats.channels_count }}</p>
                </div>
                <div class="p-3 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Rate Parity & Quick Links -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Rate Parity Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Rate Parity</h2>
                        {% if all_seasons %}
                        <select id="parity-season-select" 
                                class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                onchange="loadParityData()">
                            {% for season in all_seasons %}
                            <option value="{{ season.id }}" {% if season.id == parity_season.id %}selected{% endif %}>
                                {{ season.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    {% if parity_season and parity_room and parity_rate_plan %}
                    <p class="mt-1 text-sm text-gray-500">
                        {{ parity_room.name }} • {{ parity_rate_plan.name }} • BAR: ${{ bar_rate|floatformat:2|intcomma }}
                    </p>
                    {% endif %}
                </div>
                
                <div id="parity-content" class="p-6">
                    {% if parity_data %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="pb-3">Channel</th>
                                    <th class="pb-3 text-right">Rate</th>
                                    <th class="pb-3 text-right">vs BAR</th>
                                    <th class="pb-3 text-right">Net Revenue</th>
                                    <th class="pb-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for item in parity_data %}
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3">
                                        <span class="font-medium text-gray-900">{{ item.channel.name }}</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <span class="font-semibold text-gray-900">${{ item.rate|floatformat:2|intcomma }}</span>
                                    </td>
                                    <td class="py-3 text-right">
                                        {% if item.difference < 0 %}
                                        <span class="text-red-600">-${{ item.abs_difference|floatformat:2|intcomma }}</span>
                                        {% elif item.difference > 0 %}
                                        <span class="text-green-600">+${{ item.difference|floatformat:2|intcomma }}</span>
                                        {% else %}
                                        <span class="text-gray-500">$0.00</span>
                                        {% endif %}
                                        <span class="text-xs text-gray-400 ml-1">
                                            ({% if item.difference_percent >= 0 %}+{% endif %}{{ item.difference_percent|floatformat:1 }}%)
                                        </span>
                                    </td>
                                    <td class="py-3 text-right">
                                        <span class="text-gray-600">${{ item.net_revenue|floatformat:2|intcomma }}</span>
                                    </td>
                                    <td class="py-3 text-center">
                                        {% if item.status == 'good' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            {{ item.status_text }}
                                        </span>
                                        {% elif item.status == 'warning' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            {{ item.status_text }}
                                        </span>
                                        {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ item.status_text }}
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">No rate data available. Please set up seasons, rooms, rate plans, and channels.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Revenue Forecast Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-900">Revenue Forecast</h2>
                    <p class="mt-1 text-sm text-gray-500">Projected revenue based on channel distribution</p>
                </div>
                <div id="revenue-forecast-content" class="p-6">
                    <div class="flex items-center justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="ml-3 text-gray-500">Loading forecast...</span>
                    </div>
                </div>
            </div>

            <!-- Pickup Summary Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Pickup Summary</h2>
                        <a href="{% url 'pricing:pickup_dashboard' org_code=org.code prop_code=prop.code %}" 
                           class="text-sm text-blue-600 hover:text-blue-800">
                            View Details →
                        </a>
                    </div>
                </div>
                <div id="pickup-summary-content" class="p-6">
                    <div class="flex items-center justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="ml-3 text-gray-500">Loading pickup data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Quick Actions & Recent Reservations -->
        <div class="space-y-6">
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
                <div class="space-y-3">
                    <a href="{% url 'pricing:matrix' org_code=org.code prop_code=prop.code %}" 
                       class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 hover:border-blue-300 transition">
                        <div class="p-2 bg-blue-100 rounded-lg mr-3">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Pricing Matrix</p>
                            <p class="text-xs text-gray-500">View all rates</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'pricing:booking_analysis_dashboard' org_code=org.code prop_code=prop.code %}" 
                       class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 hover:border-green-300 transition">
                        <div class="p-2 bg-green-100 rounded-lg mr-3">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Booking Analysis</p>
                            <p class="text-xs text-gray-500">Revenue & occupancy</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'pricing:pickup_dashboard' org_code=org.code prop_code=prop.code %}" 
                       class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 hover:border-purple-300 transition">
                        <div class="p-2 bg-purple-100 rounded-lg mr-3">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Pickup Analysis</p>
                            <p class="text-xs text-gray-500">Booking pace & forecast</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'admin:index' %}" 
                       class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 hover:border-gray-400 transition">
                        <div class="p-2 bg-gray-100 rounded-lg mr-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Admin Panel</p>
                            <p class="text-xs text-gray-500">Manage data</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Seasons Overview -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-900">Seasons</h2>
                </div>
                <div class="p-4">
                    {% if seasons %}
                    <div class="space-y-2">
                        {% for season in seasons %}
                        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ season.name }}</p>
                                <p class="text-xs text-gray-500">{{ season.start_date|date:"M d" }} - {{ season.end_date|date:"M d, Y" }}</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if season.season_index >= 1.2 %}bg-red-100 text-red-800
                                    {% elif season.season_index >= 1.1 %}bg-amber-100 text-amber-800
                                    {% elif season.season_index <= 0.9 %}bg-blue-100 text-blue-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ season.season_index }}x
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500 text-center py-4">No seasons configured</p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Reservations -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Recent Reservations</h2>
                        <a href="{% url 'pricing:booking_analysis_dashboard' org_code=org.code prop_code=prop.code %}" 
                           class="text-sm text-blue-600 hover:text-blue-800">
                            View All →
                        </a>
                    </div>
                </div>
                <div class="divide-y divide-gray-100">
                    {% if recent_reservations %}
                    {% for res in recent_reservations %}
                    <div class="px-6 py-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">
                                    {{ res.confirmation_no|default:res.original_confirmation_no }}
                                </p>
                                <p class="text-xs text-gray-500">
                                    {{ res.arrival_date|date:"M d" }} - {{ res.departure_date|date:"M d, Y" }}
                                    {% if res.guest %} • {{ res.guest.name }}{% endif %}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-900">${{ res.total_amount|floatformat:0|intcomma }}</p>
                                <p class="text-xs text-gray-500">{{ res.nights }} night{{ res.nights|pluralize }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="px-6 py-8 text-center">
                        <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">No reservations yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ============================================================================
// REVENUE CHART INITIALIZATION
// ============================================================================

function initRevenueChart() {
    console.log('Initializing revenue chart...');
    
    var dataScript = document.getElementById('forecast-chart-data');
    if (!dataScript) {
        console.log('No revenue chart data found');
        return;
    }
    
    try {
        var chartData = JSON.parse(dataScript.textContent);
        console.log('Chart data loaded:', chartData);
        
        var ctx = document.getElementById('revenueChart');
        if (!ctx) {
            console.error('Revenue chart canvas not found');
            return;
        }
        
        // Destroy existing chart if any
        if (window.revenueChartInstance) {
            window.revenueChartInstance.destroy();
        }
        
        // Convert to numbers (safety check)
        var grossRevenue = chartData.gross_revenue.map(function(v) { return Number(v); });
        var netRevenue = chartData.net_revenue.map(function(v) { return Number(v); });
        var commission = chartData.commission.map(function(v) { return Number(v); });
        
        // Calculate Y-axis max for proper scaling
        var allValues = grossRevenue.concat(netRevenue, commission);
        var maxValue = Math.max.apply(null, allValues);
        var yAxisMax = Math.ceil(maxValue * 1.1 / 10000) * 10000; // Round up with 10% padding
        
        console.log('Max value:', maxValue, 'Y-axis max:', yAxisMax);
        
        // Create chart
        window.revenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.months,
                datasets: [
                    {
                        label: 'Gross Revenue',
                        data: grossRevenue,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(34, 197, 94)'
                    },
                    {
                        label: 'Net Revenue',
                        data: netRevenue,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(59, 130, 246)'
                    },
                    {
                        label: 'Commission',
                        data: commission,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgb(239, 68, 68)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + 
                                    context.parsed.y.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: yAxisMax,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'k';
                            },
                            color: '#6b7280',
                            font: { size: 11 },
                            maxTicksLimit: 8
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: true
                        }
                    },
                    x: {
                        ticks: {
                            color: '#6b7280',
                            font: { size: 11 }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        console.log('Revenue chart initialized successfully');
    } catch (error) {
        console.error('Error initializing revenue chart:', error);
    }
}

// ============================================================================
// PARITY DATA LOADING
// ============================================================================

function loadParityData() {
    var seasonSelect = document.getElementById('parity-season-select');
    if (!seasonSelect) return;
    
    var seasonId = seasonSelect.value;
    var url = "{% url 'pricing:parity_data_ajax' org_code=org.code prop_code=prop.code %}?season=" + seasonId;
    
    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('parity-content').innerHTML = data.html;
            } else {
                console.error('Parity load failed:', data.message);
            }
        })
        .catch(function(error) {
            console.error('Parity fetch error:', error);
        });
}

// ============================================================================
// REVENUE FORECAST LOADING
// ============================================================================

function loadRevenueForecast() {
    var url = "{% url 'pricing:revenue_forecast_ajax' org_code=org.code prop_code=prop.code %}";
    
    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                if (data.has_data) {
                    // Inject the HTML content
                    document.getElementById('revenue-forecast-content').innerHTML = data.revenue_html;
                    
                    // Initialize chart after DOM updates (critical!)
                    setTimeout(initRevenueChart, 100);
                } else {
                    document.getElementById('revenue-forecast-content').innerHTML = 
                        '<div class="text-center py-8">' +
                            '<svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>' +
                            '</svg>' +
                            '<p class="mt-2 text-sm text-gray-500">' + (data.message || 'No forecast data available.') + '</p>' +
                        '</div>';
                }
            } else {
                document.getElementById('revenue-forecast-content').innerHTML = 
                    '<div class="text-center py-8 text-red-500">' +
                        '<p>Error loading forecast: ' + data.message + '</p>' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Revenue forecast error:', error);
            document.getElementById('revenue-forecast-content').innerHTML = 
                '<div class="text-center py-8 text-red-500">' +
                    '<p>Failed to load forecast data</p>' +
                '</div>';
        });
}

// ============================================================================
// PICKUP SUMMARY LOADING
// ============================================================================

function loadPickupSummary() {
    var url = "{% url 'pricing:pickup_summary_ajax' org_code=org.code prop_code=prop.code %}";
    
    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('pickup-summary-content').innerHTML = data.html;
            } else {
                document.getElementById('pickup-summary-content').innerHTML = 
                    '<div class="text-center py-8">' +
                        '<svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>' +
                        '</svg>' +
                        '<p class="mt-2 text-sm text-gray-500">No pickup data available yet.</p>' +
                    '</div>';
            }
        })
        .catch(function(error) {
            console.error('Pickup summary error:', error);
            document.getElementById('pickup-summary-content').innerHTML = 
                '<div class="text-center py-8 text-gray-500">' +
                    '<p>Unable to load pickup data</p>' +
                '</div>';
        });
}

// ============================================================================
// INITIALIZE ON PAGE LOAD
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadRevenueForecast();
    loadPickupSummary();
});
</script>
{% endblock %}