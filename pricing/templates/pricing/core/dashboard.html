{% extends "pricing/base.html" %}
{% load humanize %}

{% block title %}Pricing Management - {{ hotel.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Tab Navigation */
    .tab-nav {
        display: flex;
        gap: 4px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 24px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .tab-btn {
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        background: transparent;
        border: none;
        cursor: pointer;
        white-space: nowrap;
        position: relative;
        transition: color 0.2s;
    }
    
    .tab-btn:hover { color: #374151; }
    .tab-btn.active { color: #2563eb; }
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #2563eb;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Cards */
    .mgmt-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .mgmt-card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .mgmt-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
    }
    
    /* Tables */
    .mgmt-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .mgmt-table th {
        text-align: left;
        padding: 12px 16px;
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .mgmt-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
    }
    
    .mgmt-table tr:hover td { background: #f9fafb; }
    .mgmt-table tr:last-child td { border-bottom: none; }
    
    /* Editable cells */
    .editable-input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 14px;
        background: transparent;
        transition: all 0.15s;
    }
    
    .editable-input:hover {
        border-color: #d1d5db;
        background: white;
    }
    
    .editable-input:focus {
        outline: none;
        border-color: #2563eb;
        background: white;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .editable-input.saving { background: #fef3c7; }
    .editable-input.saved { background: #d1fae5; }
    .editable-input.error { background: #fee2e2; border-color: #ef4444; }
    
    /* Input groups */
    .input-prefix, .input-suffix {
        display: flex;
        align-items: center;
    }
    .input-prefix span { color: #6b7280; padding-right: 2px; }
    .input-suffix span { color: #6b7280; padding-left: 2px; }
    
    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        border: none;
    }
    
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }
    .btn-sm { padding: 4px 10px; font-size: 13px; }
    
    /* Row actions */
    .row-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s;
    }
    
    tr:hover .row-actions { opacity: 1; }
    
    .action-btn {
        padding: 4px 8px;
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.15s;
    }
    
    .action-btn:hover { background: #f3f4f6; color: #374151; }
    .action-btn.danger:hover { background: #fee2e2; color: #dc2626; }
    
    /* Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 9999px;
    }
    
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-yellow { background: #fef3c7; color: #92400e; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .badge-gray { background: #f3f4f6; color: #4b5563; }
    
    /* Toggle switch */
    .toggle {
        position: relative;
        width: 40px;
        height: 22px;
    }
    
    .toggle input { opacity: 0; width: 0; height: 0; }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: #d1d5db;
        border-radius: 11px;
        transition: all 0.2s;
    }
    
    .toggle-slider::before {
        content: '';
        position: absolute;
        height: 18px;
        width: 18px;
        left: 2px;
        bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .toggle input:checked + .toggle-slider { background: #2563eb; }
    .toggle input:checked + .toggle-slider::before { transform: translateX(18px); }
    
    /* Empty state */
    .empty-state {
        padding: 48px 24px;
        text-align: center;
        color: #6b7280;
    }
    
    .empty-state-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        color: #d1d5db;
    }
    
    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
        padding: 20px;
    }
    
    .modal-overlay.active { opacity: 1; visibility: visible; }
    
    .modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow: hidden;
        transform: scale(0.95);
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
    }
    
    .modal-overlay.active .modal { transform: scale(1); }
    
    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-title { font-size: 18px; font-weight: 600; color: #111827; }
    
    .modal-close {
        padding: 8px;
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        border-radius: 6px;
    }
    
    .modal-close:hover { background: #f3f4f6; color: #374151; }
    
    .modal-body { 
        padding: 24px; 
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }
    
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
        background: white;
    }
    
    /* Form inside modal - make it flex for proper scrolling */
    .modal > form {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }
    
    /* Form styles */
    .form-group { margin-bottom: 20px; }
    .form-group:last-child { margin-bottom: 0; }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    
    .form-input, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.15s;
    }
    
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .form-hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
    
    /* Alert */
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    /* Toast */
    .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .toast {
        padding: 12px 16px;
        background: #1f2937;
        color: white;
        border-radius: 8px;
        font-size: 14px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
    }
    
    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

<div class="space-y-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Pricing Management</h1>
            <p class="text-gray-600 mt-1">{{ hotel.name }} · Configure pricing components</p>
        </div>
        <a href="{% url 'pricing:matrix' org_code=org_code prop_code=prop_code %}" class="btn btn-secondary">
            ← Back to Matrix
        </a>
        
    </div>
    
    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist">
        <button class="tab-btn active" data-tab="seasons">Seasons</button>
        <button class="tab-btn" data-tab="rooms">Room Types</button>
        <button class="tab-btn" data-tab="rateplans">Rate Plans</button>
        <button class="tab-btn" data-tab="channels">Channels</button>
        <button class="tab-btn" data-tab="modifiers">Rate Modifiers</button>
        <button class="tab-btn" data-tab="rt-season-mods">Room Season Modifiers</button>
    </div>
    
    <!-- Tab: Seasons -->
    <div id="tab-seasons" class="tab-content active">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <h3 class="mgmt-card-title">Seasons (Property-Specific)</h3>
                <button class="btn btn-primary btn-sm" onclick="openModal('seasonModal')">+ Add Season</button>
            </div>
            <div class="mgmt-card-body">
                {% if seasons %}
                <table class="mgmt-table" id="seasonsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Index</th>
                            <th>Exp. Occ.</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for season in seasons %}
                        <tr data-id="{{ season.id }}">
                            <td><input type="text" class="editable-input" value="{{ season.name }}" data-field="name" data-id="{{ season.id }}" data-type="season" onchange="updateField(this)"></td>
                            <td><input type="date" class="editable-input" value="{{ season.start_date|date:'Y-m-d' }}" data-field="start_date" data-id="{{ season.id }}" data-type="season" onchange="updateField(this)"></td>
                            <td><input type="date" class="editable-input" value="{{ season.end_date|date:'Y-m-d' }}" data-field="end_date" data-id="{{ season.id }}" data-type="season" onchange="updateField(this)"></td>
                            <td><div class="input-suffix"><input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ season.season_index }}" data-field="season_index" data-id="{{ season.id }}" data-type="season" onchange="updateField(this)"><span>×</span></div></td>
                            <td><div class="input-suffix"><input type="number" step="1" class="editable-input" style="width:60px;" value="{{ season.expected_occupancy }}" data-field="expected_occupancy" data-id="{{ season.id }}" data-type="season" onchange="updateField(this)"><span>%</span></div></td>
                            <td><div class="row-actions"><button class="action-btn danger" onclick="deleteItem('season', {{ season.id }}, '{{ season.name }}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No seasons defined yet.</p>
                    <button class="btn btn-primary mt-4" onclick="openModal('seasonModal')">Add Your First Season</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab: Room Types -->
    <div id="tab-rooms" class="tab-content">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <div>
                    <h3 class="mgmt-card-title">Room Types (Property-Specific)</h3>
                    <p class="text-sm text-gray-500 mt-1">
                        Reference Base Rate: 
                        <span class="inline-flex items-center">
                            <span class="text-gray-500">$</span>
                            <input type="number" step="0.01" min="0" 
                                   class="editable-input ml-1" 
                                   style="width:80px;" 
                                   value="{{ hotel.reference_base_rate }}" 
                                   data-field="reference_base_rate" 
                                   data-id="{{ hotel.id }}" 
                                   data-type="property" 
                                   onchange="updatePropertyField(this)">
                        </span>
                    </p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="openModal('roomModal')">+ Add Room Type</button>
            </div>
            <div class="mgmt-card-body">
                {% if room_types %}
                <table class="mgmt-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Method</th>
                            <th>Index/Adj</th>
                            <th>Effective Rate</th>
                            <th>Rooms</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room in room_types %}
                        <tr data-id="{{ room.id }}" data-room-index="{{ room.room_index }}" data-room-adjustment="{{ room.room_adjustment }}" data-base-rate="{{ room.base_rate }}">
                            <td><input type="text" class="editable-input" value="{{ room.name }}" data-field="name" data-id="{{ room.id }}" data-type="room" onchange="updateField(this)"></td>
                            <td>
                                <select class="editable-input room-method-select" style="width:130px;" data-field="pricing_method" data-id="{{ room.id }}" data-type="room" onchange="updateField(this); updateRoomInputDisplay(this);">
                                    <option value="index" {% if room.pricing_method == 'index' %}selected{% endif %}>Index (×)</option>
                                    <option value="adjustment" {% if room.pricing_method == 'adjustment' %}selected{% endif %}>Adjustment (+$)</option>
                                    <option value="direct" {% if room.pricing_method == 'direct' %}selected{% endif %}>Direct Rate</option>
                                </select>
                            </td>
                            <td class="room-value-cell">
                                <div class="input-suffix room-input-index" {% if room.pricing_method != 'index' %}style="display:none;"{% endif %}>
                                    <input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ room.room_index }}" data-field="room_index" data-id="{{ room.id }}" data-type="room" onchange="updateField(this); updateEffectiveRate(this);">
                                    <span>×</span>
                                </div>
                                <div class="input-prefix room-input-adjustment" {% if room.pricing_method != 'adjustment' %}style="display:none;"{% endif %}>
                                    <span>+$</span>
                                    <input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ room.room_adjustment }}" data-field="room_adjustment" data-id="{{ room.id }}" data-type="room" onchange="updateField(this); updateEffectiveRate(this);">
                                </div>
                                <div class="input-prefix room-input-direct" {% if room.pricing_method != 'direct' %}style="display:none;"{% endif %}>
                                    <span>$</span>
                                    <input type="number" step="0.01" class="editable-input" style="width:80px;" value="{{ room.base_rate }}" data-field="base_rate" data-id="{{ room.id }}" data-type="room" onchange="updateField(this); updateEffectiveRate(this);">
                                </div>
                            </td>
                            <td><span class="font-semibold text-gray-900 effective-rate" data-room-id="{{ room.id }}">${{ room.get_effective_base_rate }}</span></td>
                            <td><input type="number" class="editable-input" style="width:60px;" value="{{ room.number_of_rooms }}" data-field="number_of_rooms" data-id="{{ room.id }}" data-type="room" onchange="updateField(this)"></td>
                            <td><div class="row-actions"><button class="action-btn danger" onclick="deleteItem('room', {{ room.id }}, '{{ room.name }}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No room types defined yet.</p>
                    <button class="btn btn-primary mt-4" onclick="openModal('roomModal')">Add Your First Room Type</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab: Rate Plans -->
    <div id="tab-rateplans" class="tab-content">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <div>
                    <h3 class="mgmt-card-title">Rate Plans (Shared)</h3>
                    <p class="text-sm text-gray-500 mt-1">Meal supplements per person</p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="openModal('ratePlanModal')">+ Add Rate Plan</button>
            </div>
            <div class="mgmt-card-body">
                {% if rate_plans %}
                <table class="mgmt-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Meal Supplement (per person)</th>
                            <th>Cost for 2 pax</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plan in rate_plans %}
                        <tr data-id="{{ plan.id }}">
                            <td><input type="text" class="editable-input" value="{{ plan.name }}" data-field="name" data-id="{{ plan.id }}" data-type="rateplan" onchange="updateField(this)"></td>
                            <td><div class="input-prefix"><span>$</span><input type="number" step="0.01" class="editable-input" style="width:80px;" value="{{ plan.meal_supplement }}" data-field="meal_supplement" data-id="{{ plan.id }}" data-type="rateplan" onchange="updateField(this)"></div></td>
                            <td><span class="text-gray-600">${{ plan.meal_supplement|add:plan.meal_supplement }}</span></td>
                            <td><div class="row-actions"><button class="action-btn danger" onclick="deleteItem('rateplan', {{ plan.id }}, '{{ plan.name }}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No rate plans defined yet.</p>
                    <button class="btn btn-primary mt-4" onclick="openModal('ratePlanModal')">Add Your First Rate Plan</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab: Channels -->
    <div id="tab-channels" class="tab-content">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <div>
                    <h3 class="mgmt-card-title">Channels (Shared)</h3>
                    <p class="text-sm text-gray-500 mt-1">Distribution channels with discounts and commissions</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="normalizeDistribution()">Normalize to 100%</button>
                    <button class="btn btn-primary btn-sm" onclick="openModal('channelModal')">+ Add Channel</button>
                </div>
            </div>
            <div class="mgmt-card-body">
                {% if not distribution_valid %}
                <div class="alert {% if distribution_total == 0 %}alert-warning{% else %}alert-error{% endif %} mx-4 mt-4">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <span>{{ distribution_message }}</span>
                </div>
                {% endif %}
                
                {% if channels %}
                <table class="mgmt-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Order</th>
                            <th>Name</th>
                            <th>Base Discount</th>
                            <th>Commission</th>
                            <th>Distribution</th>
                            <th>Modifiers</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="channelsTableBody">
                        {% for channel in channels %}
                        <tr data-id="{{ channel.id }}">
                            <td><input type="number" class="editable-input" style="width:50px;" value="{{ channel.sort_order }}" data-field="sort_order" data-id="{{ channel.id }}" data-type="channel" onchange="updateField(this)"></td>
                            <td><input type="text" class="editable-input" value="{{ channel.name }}" data-field="name" data-id="{{ channel.id }}" data-type="channel" onchange="updateField(this)"></td>
                            <td><div class="input-suffix"><input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ channel.base_discount_percent }}" data-field="base_discount_percent" data-id="{{ channel.id }}" data-type="channel" onchange="updateField(this)"><span>%</span></div></td>
                            <td><div class="input-suffix"><input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ channel.commission_percent }}" data-field="commission_percent" data-id="{{ channel.id }}" data-type="channel" onchange="updateField(this)"><span>%</span></div></td>
                            <td><div class="input-suffix"><input type="number" step="0.1" class="editable-input" style="width:70px;" value="{{ channel.distribution_share_percent }}" data-field="distribution_share_percent" data-id="{{ channel.id }}" data-type="channel" onchange="updateField(this)"><span>%</span></div></td>
                            <td><span class="badge badge-blue">{{ channel.rate_modifiers.count }}</span></td>
                            <td><div class="row-actions"><button class="action-btn danger" onclick="deleteItem('channel', {{ channel.id }}, '{{ channel.name }}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No channels defined yet.</p>
                    <button class="btn btn-primary mt-4" onclick="openModal('channelModal')">Add Your First Channel</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab: Rate Modifiers -->
    <div id="tab-modifiers" class="tab-content">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <div>
                    <h3 class="mgmt-card-title">Rate Modifiers (Shared)</h3>
                    <p class="text-sm text-gray-500 mt-1">Additional discounts per channel (Genius, Mobile, etc.)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Filter:</label>
                        <select id="modifierChannelFilter" class="form-input" style="width:150px;" onchange="filterModifiersByChannel(this.value)">
                            <option value="">All Channels</option>
                            {% for channel in channels %}
                            <option value="{{ channel.id }}">{{ channel.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="openModal('stackedDiscountModal')">+ Stacked Discount</button>
                    <button class="btn btn-primary btn-sm" onclick="openModal('modifierModal')">+ Add Modifier</button>
                </div>
            </div>
            <div class="mgmt-card-body">
                {% if rate_modifiers %}
                <table class="mgmt-table" id="modifiersTable">
                    <thead>
                        <tr>
                            <th>Channel</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Discount</th>
                            <th>Stackable</th>
                            <th>Total from BAR</th>
                            <th>Active</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for modifier in rate_modifiers %}
                        <tr data-id="{{ modifier.id }}" data-channel-id="{{ modifier.channel.id }}" data-channel-base-discount="{{ modifier.channel.base_discount_percent }}">
                            <td><span class="badge badge-gray">{{ modifier.channel.name }}</span></td>
                            <td><input type="text" class="editable-input" value="{{ modifier.name }}" data-field="name" data-id="{{ modifier.id }}" data-type="modifier" onchange="updateField(this)"></td>
                            <td>
                                <select class="editable-input" style="width:130px;" data-field="modifier_type" data-id="{{ modifier.id }}" data-type="modifier" onchange="updateField(this)">
                                    <option value="standard" {% if modifier.modifier_type == 'standard' %}selected{% endif %}>Standard</option>
                                    <option value="member" {% if modifier.modifier_type == 'member' %}selected{% endif %}>Member/Loyalty</option>
                                    <option value="mobile" {% if modifier.modifier_type == 'mobile' %}selected{% endif %}>Mobile App</option>
                                    <option value="promo" {% if modifier.modifier_type == 'promo' %}selected{% endif %}>Promotional</option>
                                    <option value="corporate" {% if modifier.modifier_type == 'corporate' %}selected{% endif %}>Corporate</option>
                                    <option value="last_minute" {% if modifier.modifier_type == 'last_minute' %}selected{% endif %}>Last Minute</option>
                                    <option value="early_bird" {% if modifier.modifier_type == 'early_bird' %}selected{% endif %}>Early Bird</option>
                                </select>
                            </td>
                            <td><div class="input-suffix"><input type="number" step="0.01" class="editable-input" style="width:70px;" value="{{ modifier.discount_percent }}" data-field="discount_percent" data-id="{{ modifier.id }}" data-type="modifier" onchange="updateField(this); updateTotalFromBAR(this);"><span>%</span></div></td>
                            <td>
                                <label class="toggle">
                                    <input type="checkbox" {% if modifier.stackable %}checked{% endif %} data-field="stackable" data-id="{{ modifier.id }}" data-type="modifier" onchange="updateField(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </td>
                            <td><span class="total-from-bar font-semibold {% if modifier.total_discount_from_bar > 20 %}text-red-600{% elif modifier.total_discount_from_bar > 10 %}text-yellow-600{% else %}text-green-600{% endif %}">-{{ modifier.total_discount_from_bar }}%</span></td>
                            <td>
                                <label class="toggle">
                                    <input type="checkbox" {% if modifier.active %}checked{% endif %} onchange="toggleModifier({{ modifier.id }})">
                                    <span class="toggle-slider"></span>
                                </label>
                            </td>
                            <td><div class="row-actions"><button class="action-btn danger" onclick="deleteItem('modifier', {{ modifier.id }}, '{{ modifier.name }}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <p>No rate modifiers defined yet.</p>
                    <button class="btn btn-primary mt-4" onclick="openModal('modifierModal')">Add Your First Modifier</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab: Room Type Season Modifiers -->
    <div id="tab-rt-season-mods" class="tab-content">
        <div class="mgmt-card">
            <div class="mgmt-card-header">
                <h3 class="mgmt-card-title">Room Type Season Modifiers</h3>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-sm" style="background:#f3f4f6; color:#374151; border:1px solid #d1d5db;" onclick="resetAllRTSeasonMods()">Reset All to 1.00</button>
                    <button class="btn btn-primary btn-sm" onclick="saveAllRTSeasonMods()">Save All</button>
                </div>
            </div>
            <p style="color:#6b7280; font-size:13px; margin:0 20px 16px;">
                Adjust how each room type responds to seasonal pricing. A modifier of 1.00 means the room follows the base season index. 
                Values &gt; 1.00 amplify seasonality (higher peaks, higher lows). Values &lt; 1.00 dampen it.
                <br><strong>Effective Index = Season Index &times; Room Modifier</strong>
            </p>
            <div class="mgmt-table-container" style="overflow-x:auto;">
                <table class="mgmt-table" id="rtSeasonModTable">
                    <thead>
                        <tr>
                            <th style="text-align:left; min-width:160px;">Room Type</th>
                            <th style="text-align:right; min-width:80px;">Base Rate</th>
                            <th style="text-align:right; min-width:70px;">Target Occ%</th>
                            <!-- Season columns injected by JS -->
                        </tr>
                    </thead>
                    <tbody id="rtSeasonModBody">
                        <tr><td colspan="3" style="text-align:center; color:#9ca3af; padding:24px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div><!-- end space-y-6 -->
</div><!-- end max-w-7xl -->

<!-- Modals -->
<!-- Season Modal -->
<div id="seasonModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Season</h3>
            <button class="modal-close" onclick="closeModal('seasonModal')">×</button>
        </div>
        <form id="seasonForm" onsubmit="submitForm(event, 'season')">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Season Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="e.g., High Season">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Season Index</label>
                        <input type="number" name="season_index" class="form-input" step="0.01" value="1.00" required>
                        <p class="form-hint">Multiplier for base rates (e.g., 1.30 = 30% increase)</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expected Occupancy %</label>
                        <input type="number" name="expected_occupancy" class="form-input" step="1" value="70" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('seasonModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Season</button>
            </div>
        </form>
    </div>
</div>

<!-- Room Type Modal -->
<div id="roomModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Room Type</h3>
            <button class="modal-close" onclick="closeModal('roomModal')">×</button>
        </div>
        <form id="roomForm" onsubmit="submitForm(event, 'room')">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Room Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="e.g., Deluxe Suite">
                </div>
                <div class="form-group">
                    <label class="form-label">Pricing Method</label>
                    <select name="pricing_method" class="form-select" onchange="toggleRoomPricingFields(this.value)">
                        <option value="index">Index Multiplier (×)</option>
                        <option value="adjustment">Fixed Adjustment (+$)</option>
                        <option value="direct">Direct Base Rate</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group" id="roomIndexField">
                        <label class="form-label">Room Index</label>
                        <input type="number" name="room_index" class="form-input" step="0.01" value="1.00">
                        <p class="form-hint">e.g., 1.50 = 50% above reference rate</p>
                    </div>
                    <div class="form-group" id="roomAdjustmentField" style="display:none;">
                        <label class="form-label">Adjustment ($)</label>
                        <input type="number" name="room_adjustment" class="form-input" step="0.01" value="0">
                    </div>
                    <div class="form-group" id="roomBaseRateField" style="display:none;">
                        <label class="form-label">Base Rate ($)</label>
                        <input type="number" name="base_rate" class="form-input" step="0.01" value="{{ hotel.reference_base_rate }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Rooms</label>
                        <input type="number" name="number_of_rooms" class="form-input" value="10" min="1">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('roomModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Room Type</button>
            </div>
        </form>
    </div>
</div>

<!-- Rate Plan Modal -->
<div id="ratePlanModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Rate Plan</h3>
            <button class="modal-close" onclick="closeModal('ratePlanModal')">×</button>
        </div>
        <form id="ratePlanForm" onsubmit="submitForm(event, 'rateplan')">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Rate Plan Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="e.g., Full Board">
                </div>
                <div class="form-group">
                    <label class="form-label">Meal Supplement (per person)</label>
                    <input type="number" name="meal_supplement" class="form-input" step="0.01" value="0" required>
                    <p class="form-hint">Cost per person per night (e.g., $12 for breakfast + dinner)</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('ratePlanModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Rate Plan</button>
            </div>
        </form>
    </div>
</div>

<!-- Channel Modal -->
<div id="channelModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Channel</h3>
            <button class="modal-close" onclick="closeModal('channelModal')">×</button>
        </div>
        <form id="channelForm" onsubmit="submitForm(event, 'channel')">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Channel Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="e.g., Booking.com">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Base Discount %</label>
                        <input type="number" name="base_discount_percent" class="form-input" step="0.01" value="0">
                        <p class="form-hint">Discount from BAR</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Commission %</label>
                        <input type="number" name="commission_percent" class="form-input" step="0.01" value="0">
                        <p class="form-hint">Channel takes this %</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Distribution Share %</label>
                    <input type="number" name="distribution_share_percent" class="form-input" step="0.1" value="0">
                    <p class="form-hint">Expected % of bookings from this channel</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('channelModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Channel</button>
            </div>
        </form>
    </div>
</div>

<!-- Modifier Modal -->
<div id="modifierModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Add Rate Modifier</h3>
            <button class="modal-close" onclick="closeModal('modifierModal')">×</button>
        </div>
        <form id="modifierForm" onsubmit="submitForm(event, 'modifier')">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Channel</label>
                    <select name="channel_id" class="form-select" required>
                        <option value="">Select Channel...</option>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}">{{ channel.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Modifier Name</label>
                    <input type="text" name="name" class="form-input" required placeholder="e.g., Genius Level 2">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select name="modifier_type" class="form-select">
                            <option value="standard">Standard Rate</option>
                            <option value="member">Member/Loyalty</option>
                            <option value="mobile">Mobile App</option>
                            <option value="promo">Promotional</option>
                            <option value="corporate">Corporate</option>
                            <option value="last_minute">Last Minute</option>
                            <option value="early_bird">Early Bird</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount %</label>
                        <input type="number" name="discount_percent" class="form-input" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <input type="text" name="description" class="form-input" placeholder="e.g., For Genius Level 2 members">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('modifierModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Modifier</button>
            </div>
        </form>
    </div>
</div>

<!-- Stacked Discount Modal -->
<div id="stackedDiscountModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Create Stacked Discount</h3>
            <button class="modal-close" onclick="closeModal('stackedDiscountModal')">×</button>
        </div>
        <form id="stackedDiscountForm" onsubmit="createStackedDiscount(event)">
            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-4">Combine multiple stackable modifiers (e.g., Mobile + Genius) into a single rate modifier.</p>
                
                <div class="form-group">
                    <label class="form-label">Channel</label>
                    <select id="stackedChannel" name="channel_id" class="form-select" required onchange="loadStackableModifiers(this.value)">
                        <option value="">Select Channel...</option>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}">{{ channel.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Modifiers to Stack</label>
                    <div id="stackableModifiersList" class="border border-gray-200 rounded-lg p-3 min-h-[100px] bg-gray-50">
                        <p class="text-sm text-gray-500">Select a channel first...</p>
                    </div>
                    <p class="form-hint">Only modifiers marked as "stackable" can be combined</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Combined Discount Preview</label>
                    <div id="stackedDiscountPreview" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total Stacked Discount:</span>
                            <span id="stackedDiscountTotal" class="text-lg font-bold text-blue-600">0%</span>
                        </div>
                        <div id="stackedDiscountBreakdown" class="text-xs text-gray-500 mt-1"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Modifier Name</label>
                    <input type="text" id="stackedModifierName" name="name" class="form-input" required placeholder="e.g., Mobile + Genius">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('stackedDiscountModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Stacked Modifier</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" style="max-width: 400px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Delete</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">×</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
            <p class="text-sm text-gray-500 mt-2">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
// Configuration
var API_BASE = '/org/{{ org_code }}/{{ prop_code }}';
var SHARED_API_BASE = '/pricing';

// Tab switching
document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var tabId = this.getAttribute('data-tab');
        
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        
        this.classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
    });
});

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
    // Reset form
    var form = document.getElementById(modalId.replace('Modal', 'Form'));
    if (form) form.reset();
}

function closeModalOnOverlay(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Toast notifications
function showToast(message, type) {
    type = type || 'success';
    var container = document.getElementById('toastContainer');
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(function() {
        toast.remove();
    }, 3000);
}

// API URL helpers
function getApiUrl(type, action, id) {
    var propertyTypes = ['season', 'room', 'season-override'];
    var base = propertyTypes.indexOf(type) >= 0 ? API_BASE : SHARED_API_BASE;
    
    var typeMap = {
        'season': 'seasons',
        'room': 'room-types',
        'rateplan': 'rate-plans',
        'channel': 'channels',
        'modifier': 'modifiers',
        'season-override': 'season-overrides'
    };
    
    var endpoint = typeMap[type] || type + 's';
    
    if (action === 'create') {
        return base + '/api/' + endpoint + '/create/';
    } else if (action === 'update' || action === 'delete') {
        return base + '/api/' + endpoint + '/' + id + '/' + action + '/';
    } else if (action === 'toggle') {
        return base + '/api/' + endpoint + '/' + id + '/toggle/';
    }
    
    return base + '/api/' + endpoint + '/';
}

// Update field inline
function updateField(input) {
    var type = input.getAttribute('data-type');
    var id = input.getAttribute('data-id');
    var field = input.getAttribute('data-field');
    var value = input.value;
    
    input.classList.add('saving');
    
    var data = {};
    data[field] = value;
    
    fetch(getApiUrl(type, 'update', id), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        input.classList.remove('saving');
        if (data.success) {
            input.classList.add('saved');
            setTimeout(function() { input.classList.remove('saved'); }, 1000);
        } else {
            input.classList.add('error');
            showToast(data.error || 'Update failed', 'error');
            setTimeout(function() { input.classList.remove('error'); }, 2000);
        }
    })
    .catch(function(err) {
        input.classList.remove('saving');
        input.classList.add('error');
        showToast('Network error', 'error');
        setTimeout(function() { input.classList.remove('error'); }, 2000);
    });
}

// Update property field (reference_base_rate, etc.)
function updatePropertyField(input) {
    var field = input.getAttribute('data-field');
    var value = input.value;
    
    input.classList.add('saving');
    
    var data = {};
    data[field] = value;
    
    fetch(API_BASE + '/api/property/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        input.classList.remove('saving');
        if (data.success) {
            input.classList.add('saved');
            showToast('Reference base rate updated');
            setTimeout(function() { input.classList.remove('saved'); }, 1000);
            // Recalculate effective rates for all room types
            if (field === 'reference_base_rate') {
                updateAllEffectiveRates();
            }
        } else {
            input.classList.add('error');
            showToast(data.error || 'Update failed', 'error');
            setTimeout(function() { input.classList.remove('error'); }, 2000);
        }
    })
    .catch(function(err) {
        input.classList.remove('saving');
        input.classList.add('error');
        showToast('Network error', 'error');
        setTimeout(function() { input.classList.remove('error'); }, 2000);
    });
}

// Get reference base rate from the page
function getReferenceBaseRate() {
    var input = document.querySelector('input[data-field="reference_base_rate"]');
    return input ? parseFloat(input.value) || 0 : 0;
}

// Update which input is shown based on pricing method
function updateRoomInputDisplay(selectElement) {
    var row = selectElement.closest('tr');
    var method = selectElement.value;
    
    // Hide all input containers
    var indexDiv = row.querySelector('.room-input-index');
    var adjustmentDiv = row.querySelector('.room-input-adjustment');
    var directDiv = row.querySelector('.room-input-direct');
    
    indexDiv.style.display = 'none';
    adjustmentDiv.style.display = 'none';
    directDiv.style.display = 'none';
    
    // Show the appropriate one
    if (method === 'index') {
        indexDiv.style.display = '';
    } else if (method === 'adjustment') {
        adjustmentDiv.style.display = '';
    } else if (method === 'direct') {
        directDiv.style.display = '';
    }
    
    // Recalculate effective rate
    updateEffectiveRateForRow(row);
}

// Calculate and update effective rate for a row
function updateEffectiveRateForRow(row) {
    var referenceRate = getReferenceBaseRate();
    var roomId = row.getAttribute('data-id');
    var methodSelect = row.querySelector('select[data-field="pricing_method"]');
    var method = methodSelect.value;
    
    var effectiveRate = 0;
    
    if (method === 'index') {
        var indexInput = row.querySelector('input[data-field="room_index"]');
        var roomIndex = parseFloat(indexInput.value) || 1;
        effectiveRate = referenceRate * roomIndex;
    } else if (method === 'adjustment') {
        var adjustmentInput = row.querySelector('input[data-field="room_adjustment"]');
        var roomAdjustment = parseFloat(adjustmentInput.value) || 0;
        effectiveRate = referenceRate + roomAdjustment;
    } else if (method === 'direct') {
        var baseRateInput = row.querySelector('input[data-field="base_rate"]');
        effectiveRate = parseFloat(baseRateInput.value) || 0;
    }
    
    // Update the display
    var effectiveRateSpan = row.querySelector('.effective-rate');
    if (effectiveRateSpan) {
        effectiveRateSpan.textContent = '$' + effectiveRate.toFixed(2);
    }
}

// Called when any room value input changes
function updateEffectiveRate(input) {
    var row = input.closest('tr');
    updateEffectiveRateForRow(row);
}

// Update all effective rates (called when reference base rate changes)
function updateAllEffectiveRates() {
    var rows = document.querySelectorAll('#tab-rooms tbody tr[data-id]');
    rows.forEach(function(row) {
        updateEffectiveRateForRow(row);
    });
}

// Submit form (create new)
function submitForm(event, type) {
    event.preventDefault();
    
    var form = event.target;
    var formData = new FormData(form);
    var data = {};
    
    formData.forEach(function(value, key) {
        data[key] = value;
    });
    
    fetch(getApiUrl(type, 'create'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            showToast(data.message || 'Created successfully');
            closeModal(type + 'Modal');
            setTimeout(function() { location.reload(); }, 500);
        } else {
            showToast(data.error || 'Creation failed', 'error');
        }
    })
    .catch(function(err) {
        showToast('Network error', 'error');
    });
}

// Delete item
var deleteType, deleteId;

function deleteItem(type, id, name) {
    deleteType = type;
    deleteId = id;
    document.getElementById('deleteItemName').textContent = name;
    document.getElementById('confirmDeleteBtn').onclick = confirmDelete;
    openModal('deleteModal');
}

function confirmDelete() {
    fetch(getApiUrl(deleteType, 'delete', deleteId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            showToast(data.message || 'Deleted successfully');
            closeModal('deleteModal');
            // Remove row from table
            var row = document.querySelector('tr[data-id="' + deleteId + '"]');
            if (row) row.remove();
        } else {
            showToast(data.error || 'Delete failed', 'error');
        }
    })
    .catch(function(err) {
        showToast('Network error', 'error');
    });
}

// Toggle modifier active state
function toggleModifier(id) {
    fetch(getApiUrl('modifier', 'toggle', id), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            showToast(data.message);
        } else {
            showToast(data.error || 'Toggle failed', 'error');
        }
    })
    .catch(function(err) {
        showToast('Network error', 'error');
    });
}

// Normalize distribution
function normalizeDistribution() {
    fetch(SHARED_API_BASE + '/api/channels/normalize-distribution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            showToast(data.message);
            setTimeout(function() { location.reload(); }, 500);
        } else {
            showToast(data.error || 'Failed', 'error');
        }
    });
}

// Room pricing fields toggle
function toggleRoomPricingFields(method) {
    document.getElementById('roomIndexField').style.display = method === 'index' ? 'block' : 'none';
    document.getElementById('roomAdjustmentField').style.display = method === 'adjustment' ? 'block' : 'none';
    document.getElementById('roomBaseRateField').style.display = method === 'direct' ? 'block' : 'none';
}

// CSRF token helper
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Filter modifiers table by channel
function filterModifiersByChannel(channelId) {
    var rows = document.querySelectorAll('#modifiersTable tbody tr');
    rows.forEach(function(row) {
        if (!channelId || row.getAttribute('data-channel-id') === channelId) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Update Total from BAR when modifier discount changes
function updateTotalFromBAR(input) {
    var row = input.closest('tr');
    var channelBaseDiscount = parseFloat(row.getAttribute('data-channel-base-discount')) || 0;
    var modifierDiscount = parseFloat(input.value) || 0;
    var totalDiscount = channelBaseDiscount + modifierDiscount;
    
    var totalSpan = row.querySelector('.total-from-bar');
    if (totalSpan) {
        totalSpan.textContent = '-' + totalDiscount.toFixed(2) + '%';
        
        // Update color class based on discount level
        totalSpan.classList.remove('text-red-600', 'text-yellow-600', 'text-green-600');
        if (totalDiscount > 20) {
            totalSpan.classList.add('text-red-600');
        } else if (totalDiscount > 10) {
            totalSpan.classList.add('text-yellow-600');
        } else {
            totalSpan.classList.add('text-green-600');
        }
    }
}

// Store stackable modifiers data
var stackableModifiersData = [];
var selectedStackModifiers = [];

// Load stackable modifiers for a channel
function loadStackableModifiers(channelId) {
    var container = document.getElementById('stackableModifiersList');
    
    if (!channelId) {
        container.innerHTML = '<p class="text-sm text-gray-500">Select a channel first...</p>';
        selectedStackModifiers = [];
        updateStackedDiscountPreview();
        return;
    }
    
    // Get modifiers from the table that are stackable for this channel
    var rows = document.querySelectorAll('#modifiersTable tbody tr[data-channel-id="' + channelId + '"]');
    stackableModifiersData = [];
    
    rows.forEach(function(row) {
        var stackableCheckbox = row.querySelector('input[data-field="stackable"]');
        if (stackableCheckbox && stackableCheckbox.checked) {
            var id = row.getAttribute('data-id');
            var nameInput = row.querySelector('input[data-field="name"]');
            var discountInput = row.querySelector('input[data-field="discount_percent"]');
            
            stackableModifiersData.push({
                id: id,
                name: nameInput ? nameInput.value : 'Unknown',
                discount: discountInput ? parseFloat(discountInput.value) || 0 : 0
            });
        }
    });
    
    if (stackableModifiersData.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No stackable modifiers found for this channel. Mark modifiers as "Stackable" first.</p>';
        selectedStackModifiers = [];
        updateStackedDiscountPreview();
        return;
    }
    
    // Build checkboxes
    var html = '';
    stackableModifiersData.forEach(function(mod) {
        html += '<label class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">';
        html += '<input type="checkbox" class="stack-modifier-checkbox" value="' + mod.id + '" data-discount="' + mod.discount + '" data-name="' + mod.name + '" onchange="updateStackSelection()">';
        html += '<span class="text-sm">' + mod.name + '</span>';
        html += '<span class="text-xs text-gray-500 ml-auto">-' + mod.discount + '%</span>';
        html += '</label>';
    });
    
    container.innerHTML = html;
    selectedStackModifiers = [];
    updateStackedDiscountPreview();
}

// Update selection and preview
function updateStackSelection() {
    selectedStackModifiers = [];
    var checkboxes = document.querySelectorAll('.stack-modifier-checkbox:checked');
    var names = [];
    
    checkboxes.forEach(function(cb) {
        selectedStackModifiers.push({
            id: cb.value,
            name: cb.getAttribute('data-name'),
            discount: parseFloat(cb.getAttribute('data-discount')) || 0
        });
        names.push(cb.getAttribute('data-name'));
    });
    
    // Auto-generate name
    var nameInput = document.getElementById('stackedModifierName');
    if (names.length > 0) {
        nameInput.value = names.join(' + ');
    } else {
        nameInput.value = '';
    }
    
    updateStackedDiscountPreview();
}

// Update the stacked discount preview
function updateStackedDiscountPreview() {
    var totalDiscount = 0;
    var breakdownParts = [];
    
    selectedStackModifiers.forEach(function(mod) {
        totalDiscount += mod.discount;
        breakdownParts.push(mod.name + ': -' + mod.discount + '%');
    });
    
    document.getElementById('stackedDiscountTotal').textContent = '-' + totalDiscount.toFixed(2) + '%';
    document.getElementById('stackedDiscountBreakdown').textContent = breakdownParts.join(' + ') || 'Select modifiers above';
}

// Create the stacked discount modifier
function createStackedDiscount(event) {
    event.preventDefault();
    
    var channelId = document.getElementById('stackedChannel').value;
    var name = document.getElementById('stackedModifierName').value.trim();
    
    if (!channelId) {
        showToast('Please select a channel', 'error');
        return;
    }
    
    if (selectedStackModifiers.length < 2) {
        showToast('Please select at least 2 modifiers to stack', 'error');
        return;
    }
    
    if (!name) {
        showToast('Please enter a name for the stacked modifier', 'error');
        return;
    }
    
    // Calculate total discount
    var totalDiscount = 0;
    var stackedIds = [];
    selectedStackModifiers.forEach(function(mod) {
        totalDiscount += mod.discount;
        stackedIds.push(mod.id);
    });
    
    // Create new modifier via API
    var data = {
        channel_id: channelId,
        name: name,
        discount_percent: totalDiscount,
        modifier_type: 'promo',
        description: 'Stacked discount: ' + selectedStackModifiers.map(function(m) { return m.name; }).join(' + '),
        is_stacked: true,
        stacked_from: stackedIds
    };
    
    fetch(getApiUrl('modifier', 'create'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            showToast('Stacked modifier created: ' + name);
            closeModal('stackedDiscountModal');
            setTimeout(function() { location.reload(); }, 500);
        } else {
            showToast(data.error || 'Creation failed', 'error');
        }
    })
    .catch(function(err) {
        showToast('Network error', 'error');
    });
}

// =========================================================================
// ROOM TYPE SEASON MODIFIERS
// =========================================================================

var rtSeasonModData = null;

function loadRTSeasonMods() {
    fetch(API_BASE + '/api/room-type-season-modifiers/', {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (!data.success) { showToast('Failed to load modifiers', 'error'); return; }
        rtSeasonModData = data;
        renderRTSeasonModGrid(data);
    })
    .catch(function() { showToast('Network error loading modifiers', 'error'); });
}

function renderRTSeasonModGrid(data) {
    var seasons = data.seasons;
    var grid = data.grid;
    
    // Update header
    var thead = document.querySelector('#rtSeasonModTable thead tr');
    // Remove old season columns
    while (thead.children.length > 3) thead.removeChild(thead.lastChild);
    
    seasons.forEach(function(s) {
        var th = document.createElement('th');
        th.style.textAlign = 'center';
        th.style.minWidth = '130px';
        th.innerHTML = '<div style="font-weight:600;">' + s.name + '</div>' +
            '<div style="font-size:11px; color:#6b7280;">Index: ' + s.index.toFixed(2) + '</div>';
        thead.appendChild(th);
    });
    
    // Build body
    var tbody = document.getElementById('rtSeasonModBody');
    tbody.innerHTML = '';
    
    grid.forEach(function(room) {
        var tr = document.createElement('tr');
        
        // Room name cell
        var tdName = document.createElement('td');
        tdName.style.textAlign = 'left';
        tdName.style.fontWeight = '600';
        tdName.innerHTML = room.room_type_name +
            (room.description ? '<div style="font-size:11px; color:#9ca3af; font-weight:400;">' + room.description + '</div>' : '') +
            '<div style="font-size:11px; color:#6b7280; font-weight:400;">$' + room.effective_rate.toFixed(0) +
            (room.premium_percent > 0 ? ' (+' + room.premium_percent.toFixed(0) + '%)' : '') + '</div>';
        tr.appendChild(tdName);
        
        // Base rate cell
        var tdRate = document.createElement('td');
        tdRate.style.textAlign = 'right';
        tdRate.style.color = '#374151';
        tdRate.textContent = '$' + room.effective_rate.toFixed(0);
        tr.appendChild(tdRate);
        
        // Target occ cell
        var tdOcc = document.createElement('td');
        tdOcc.style.textAlign = 'right';
        tdOcc.textContent = room.target_occupancy.toFixed(0) + '%';
        tr.appendChild(tdOcc);
        
        // Season modifier cells
        seasons.forEach(function(season) {
            var td = document.createElement('td');
            td.style.textAlign = 'center';
            td.style.padding = '6px 4px';
            
            var modData = room.seasons[season.id] || {modifier: 1.0, effective_index: season.index};
            var modVal = modData.modifier;
            var effIdx = modData.effective_index;
            
            var input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0.01';
            input.max = '5.00';
            input.value = modVal.toFixed(2);
            input.style.cssText = 'width:70px; text-align:center; padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;';
            input.dataset.roomTypeId = room.room_type_id;
            input.dataset.seasonId = season.id;
            input.className = 'rt-season-mod-input';
            
            input.addEventListener('input', function() {
                var val = parseFloat(this.value) || 1.0;
                var eff = (season.index * val).toFixed(2);
                this.parentElement.querySelector('.eff-idx').textContent = '→ ' + eff;
                var effVal = parseFloat(eff);
                var badge = this.parentElement.querySelector('.eff-idx');
                badge.style.color = effVal > 1.2 ? '#059669' : effVal < 0.8 ? '#dc2626' : '#6b7280';
            });
            
            td.appendChild(input);
            
            var effSpan = document.createElement('div');
            effSpan.className = 'eff-idx';
            effSpan.style.cssText = 'font-size:11px; margin-top:2px; font-weight:500;';
            effSpan.style.color = effIdx > 1.2 ? '#059669' : effIdx < 0.8 ? '#dc2626' : '#6b7280';
            effSpan.textContent = '→ ' + effIdx.toFixed(2);
            td.appendChild(effSpan);
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

function saveAllRTSeasonMods() {
    var inputs = document.querySelectorAll('.rt-season-mod-input');
    var updates = [];
    
    inputs.forEach(function(input) {
        var val = parseFloat(input.value);
        if (isNaN(val) || val < 0.01) val = 1.00;
        updates.push({
            room_type_id: parseInt(input.dataset.roomTypeId),
            season_id: parseInt(input.dataset.seasonId),
            modifier: val.toFixed(2)
        });
    });
    
    fetch(API_BASE + '/api/room-type-season-modifiers/bulk-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({updates: updates})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            showToast(data.message || 'Saved', 'success');
            loadRTSeasonMods();
        } else {
            showToast(data.error || 'Save failed', 'error');
        }
    })
    .catch(function() { showToast('Network error', 'error'); });
}

function resetAllRTSeasonMods() {
    var inputs = document.querySelectorAll('.rt-season-mod-input');
    inputs.forEach(function(input) {
        input.value = '1.00';
        input.dispatchEvent(new Event('input'));
    });
}

// Load RT Season Mods when tab is first activated
document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        if (this.dataset.tab === 'rt-season-mods' && !rtSeasonModData) {
            loadRTSeasonMods();
        }
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(function(m) {
            m.classList.remove('active');
        });
        document.body.style.overflow = '';
    }
});
</script>
{% endblock %}