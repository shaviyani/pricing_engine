{% extends 'pricing/base.html' %}
{% load humanize %}
{% load pricing_filters %}

{% block title %}Pricing Matrix (Channel View) - {{ property.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Pricing Matrix</h1>
            <p class="text-gray-600 mt-1">Channel-centric view with B&B Standard rates</p>
        </div>
        <div class="flex space-x-2">
            <!-- View Toggle -->
            <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
                <a href="{% url 'pricing:matrix' org_code=org.code prop_code=property.code %}" 
                   class="px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md">
                    By Room
                </a>
                <span class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md">
                    By Channel
                </span>
            </div>
            <!-- PDF Export Button -->
            <a href="{% url 'pricing:pricing_matrix_pdf' org_code=org.code prop_code=property.code %}" 
               class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Export PDF
            </a>
            <!-- Back to Dashboard -->
            <a href="{% url 'pricing:property_dashboard' org_code=org.code prop_code=property.code %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>

    {% if not has_data %}
    <!-- No Data State -->
    <div class="bg-white rounded-xl shadow-sm border p-12 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Pricing Data Available</h3>
        <p class="text-gray-500 mb-6">Set up seasons, rooms, rate plans, and channels to view the pricing matrix.</p>
        <div class="flex justify-center space-x-3">
            <a href="{% url 'pricing:season_list' org_code=org.code prop_code=property.code %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Seasons</a>
            <a href="{% url 'pricing:room_list' org_code=org.code prop_code=property.code %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Add Rooms</a>
        </div>
    </div>
    {% else %}

    <!-- Pricing Matrix Table -->
    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <!-- Table Header - Seasons -->
                <thead>
                    <tr class="bg-gradient-to-r from-slate-700 to-slate-800">
                        <th class="px-4 py-3 text-left text-sm font-semibold text-white sticky left-0 bg-slate-700 z-10 min-w-[200px]">
                            CHANNEL / ROOM
                        </th>
                        {% for season in seasons %}
                        <th class="px-4 py-3 text-center min-w-[120px]">
                            <div class="text-sm font-semibold text-white">{{ season.name }}</div>
                            <div class="text-xs text-slate-300">{{ season.start_date|date:"M d" }} - {{ season.end_date|date:"M d" }}</div>
                            <div class="text-xs text-blue-300">√ó{{ season.season_index }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for channel_id, channel_data in matrix.items %}
                    <!-- Channel Header Row -->
                    <tr class="bg-gradient-to-r from-blue-100 to-blue-200 cursor-pointer hover:from-blue-200 hover:to-blue-300 transition"
                        onclick="toggleSection('channel-{{ channel_id }}')">
                        <td class="px-4 py-3 sticky left-0 bg-blue-100 z-10">
                            <div class="flex items-center">
                                <svg id="chevron-channel-{{ channel_id }}" class="w-5 h-5 text-blue-600 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <div>
                                    <span class="font-bold text-blue-900">{{ channel_data.channel.name }}</span>
                                    <div class="text-xs text-blue-700">
                                        {% if channel_data.channel.base_discount_percent > 0 %}
                                        <span class="text-green-600">-{{ channel_data.channel.base_discount_percent }}%</span>
                                        {% endif %}
                                        {% if channel_data.channel.commission_percent > 0 %}
                                        <span class="text-orange-600 ml-1">{{ channel_data.channel.commission_percent }}% comm</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-3 text-center bg-blue-50"></td>
                        {% endfor %}
                    </tr>

                    <!-- Room Rows (under each channel) -->
                    {% for room_id, room_data in channel_data.rooms.items %}
                    <tr class="channel-{{ channel_id }}-content hidden bg-gray-50 hover:bg-gray-100 cursor-pointer transition"
                        onclick="toggleSection('channel-{{ channel_id }}-room-{{ room_id }}')">
                        <td class="px-4 py-2 sticky left-0 bg-gray-50 z-10">
                            <div class="flex items-center pl-6">
                                <svg id="chevron-channel-{{ channel_id }}-room-{{ room_id }}" class="w-4 h-4 text-gray-400 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <div>
                                    <span class="font-medium text-gray-900">{{ room_data.room.name }}</span>
                                    <div class="text-xs text-gray-500">{{ room_data.room.number_of_rooms }} rooms ‚Ä¢ Base: ${{ room_data.room.base_rate }}</div>
                                </div>
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-2 text-center">
                            {% with rate=room_data.summary_rates|get_item:season.id %}
                            {% if rate %}
                            <div class="font-semibold text-gray-900">${{ rate|floatformat:0 }}</div>
                            <div class="text-xs text-gray-500">B&B Std</div>
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Rate Plan Details (under each room) -->
                    {% for rate_plan_id, rp_data in room_data.rate_plans.items %}
                    <!-- Rate Plan Header -->
                    <tr class="channel-{{ channel_id }}-room-{{ room_id }}-content hidden bg-blue-50">
                        <td class="px-4 py-2 sticky left-0 bg-blue-50 z-10">
                            <div class="pl-12 font-medium text-blue-800">
                                {{ rp_data.rate_plan.name }}
                                {% if rp_data.rate_plan.meal_supplement > 0 %}
                                <span class="text-xs text-blue-600">(+${{ rp_data.rate_plan.meal_supplement }}/person)</span>
                                {% endif %}
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-2 text-center bg-blue-50"></td>
                        {% endfor %}
                    </tr>

                    <!-- BAR Row -->
                    <tr class="channel-{{ channel_id }}-room-{{ room_id }}-content hidden">
                        <td class="px-4 py-1.5 sticky left-0 bg-white z-10">
                            <div class="pl-16 text-sm text-gray-600">BAR</div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-1.5 text-center text-sm text-gray-600">
                            {% with bar=rp_data.bar_rates|get_item:season.id %}
                            {% if bar %}${{ bar|floatformat:0 }}{% else %}‚Äî{% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Modifier Rows -->
                    {% for mod_data in rp_data.modifiers %}
                    <tr class="channel-{{ channel_id }}-room-{{ room_id }}-content hidden hover:bg-gray-50">
                        <td class="px-4 py-1.5 sticky left-0 bg-white z-10">
                            <div class="pl-16 text-sm flex items-center">
                                {% if mod_data.modifier.modifier_type == 'member' %}
                                <span class="text-yellow-500 mr-1">üéØ</span>
                                {% elif mod_data.modifier.modifier_type == 'mobile' %}
                                <span class="text-blue-500 mr-1">üì±</span>
                                {% elif mod_data.modifier.modifier_type == 'country' %}
                                <span class="text-green-500 mr-1">üåç</span>
                                {% else %}
                                <span class="text-gray-400 mr-1">‚Ä¢</span>
                                {% endif %}
                                <span class="text-gray-700">{{ mod_data.modifier.name }}</span>
                                {% if mod_data.modifier.discount_percent > 0 %}
                                <span class="text-xs text-green-600 ml-1">(-{{ mod_data.modifier.discount_percent }}%)</span>
                                {% endif %}
                            </div>
                        </td>
                        {% for season in seasons %}
                        <td class="px-4 py-1.5 text-center">
                            {% with season_rates=mod_data.seasons|get_item:season.id %}
                            {% if season_rates %}
                            <div class="text-sm font-medium text-gray-900">${{ season_rates.rate|floatformat:0 }}</div>
                            {% if channel_data.channel.commission_percent > 0 %}
                            <div class="text-xs text-gray-500">Net: ${{ season_rates.breakdown.net_revenue|floatformat:0 }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-xl shadow-sm border p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Legend</h3>
        <div class="flex flex-wrap gap-4 text-sm">
            <div class="flex items-center">
                <span class="w-4 h-4 bg-gradient-to-r from-blue-100 to-blue-200 rounded mr-2"></span>
                <span class="text-gray-600">Channel Header</span>
            </div>
            <div class="flex items-center">
                <span class="w-4 h-4 bg-gray-50 rounded mr-2"></span>
                <span class="text-gray-600">Room Summary (B&B Standard)</span>
            </div>
            <div class="flex items-center">
                <span class="text-yellow-500 mr-1">üéØ</span>
                <span class="text-gray-600">Member Rate</span>
            </div>
            <div class="flex items-center">
                <span class="text-blue-500 mr-1">üì±</span>
                <span class="text-gray-600">Mobile Rate</span>
            </div>
            <div class="flex items-center">
                <span class="text-green-500 mr-1">üåç</span>
                <span class="text-gray-600">Country Rate</span>
            </div>
        </div>
    </div>

    {% endif %}
</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sticky { position: sticky; }
    
    /* Compact table spacing */
    table th, table td {
        padding: 0.5rem 0.75rem;
    }
    
    /* Smooth transitions */
    tr {
        transition: background-color 0.15s ease;
    }
    
    /* Chevron rotation */
    .rotate-90 {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function toggleSection(sectionId) {
    // Find all rows that belong to this section
    var rows = document.querySelectorAll('.' + sectionId + '-content');
    var chevron = document.getElementById('chevron-' + sectionId);
    
    // Check if currently hidden
    var isHidden = rows.length > 0 && rows[0].classList.contains('hidden');
    
    rows.forEach(function(row) {
        if (isHidden) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
            // Also hide any nested sections
            var nestedRows = row.querySelectorAll('[class*="-content"]');
            nestedRows.forEach(function(nested) {
                nested.classList.add('hidden');
            });
        }
    });
    
    // Rotate chevron
    if (chevron) {
        if (isHidden) {
            chevron.classList.add('rotate-90');
        } else {
            chevron.classList.remove('rotate-90');
            // Also reset nested chevrons
            var nestedChevrons = document.querySelectorAll('[id^="chevron-' + sectionId + '-"]');
            nestedChevrons.forEach(function(nc) {
                nc.classList.remove('rotate-90');
            });
        }
    }
}

// Expand all channels by default on page load (optional)
document.addEventListener('DOMContentLoaded', function() {
    // Uncomment below to auto-expand first channel
    // var firstChannel = document.querySelector('[id^="chevron-channel-"]');
    // if (firstChannel) {
    //     var channelId = firstChannel.id.replace('chevron-', '');
    //     toggleSection(channelId);
    // }
});
</script>
{% endblock %}